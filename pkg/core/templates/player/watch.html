<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RetroVue â€” {{CHANNEL_NAME}}</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0a;
    font-family: 'Courier New', monospace;
    color: #e0e0e0;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .tv-frame {
    position: relative;
    width: min(90vw, 960px);
    aspect-ratio: 16/9;
    border-radius: 24px;
    background: #111;
    box-shadow:
      0 0 60px rgba(100,200,255,0.08),
      inset 0 0 80px rgba(0,0,0,0.9),
      0 4px 30px rgba(0,0,0,0.8);
    border: 6px solid #222;
    overflow: hidden;
  }
  video {
    width: 100%;
    height: 100%;
    display: block;
    background: #000;
  }
  .crt-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg, transparent, transparent 2px,
      rgba(0,0,0,0.12) 2px, rgba(0,0,0,0.12) 4px
    );
    pointer-events: none;
    z-index: 10;
  }
  .crt-curve {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.4) 100%);
    pointer-events: none;
    z-index: 11;
  }
  .channel-badge {
    position: absolute;
    top: 16px; right: 20px;
    background: rgba(0,0,0,0.7);
    color: #ffc107;
    padding: 6px 14px;
    font-size: 0.9rem;
    font-weight: bold;
    letter-spacing: 2px;
    text-transform: uppercase;
    border: 1px solid #ffc107;
    border-radius: 4px;
    z-index: 20;
    text-shadow: 0 0 8px rgba(255,193,7,0.5);
    opacity: 1;
    transition: opacity 0.5s;
  }
  .channel-badge.fade { opacity: 0; }
  /* Big unmute overlay */
  .unmute-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 30;
    cursor: pointer;
    background: rgba(0,0,0,0.3);
    transition: opacity 0.3s;
  }
  .unmute-overlay.hidden { opacity: 0; pointer-events: none; }
  .unmute-btn {
    background: rgba(0,0,0,0.8);
    color: #ffc107;
    border: 2px solid #ffc107;
    border-radius: 50%;
    width: 80px; height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    text-shadow: 0 0 20px rgba(255,193,7,0.6);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  .controls {
    margin-top: 20px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .controls a {
    display: inline-block;
    font-family: 'Courier New', monospace;
    background: #1a237e;
    color: #ffc107;
    border: 1px solid #ffc107;
    padding: 8px 16px;
    text-decoration: none;
    font-size: 0.8rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
  }
  .controls a:hover, .controls a.active {
    background: #ffc107;
    color: #1a237e;
  }
  .status {
    margin-top: 10px;
    font-size: 0.7rem;
    color: #666;
  }
  .status.error { color: #ff5252; }
  .status.buffering { color: #ffc107; }
  /* Buffering splash overlay */
  .splash-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 25;
    background: #1a1a2e;
    transition: opacity 0.8s ease-out;
    overflow: hidden;
  }
  .splash-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4"><rect width="4" height="4" fill="%23222"/><rect x="0" y="0" width="1" height="1" fill="%23333" opacity="0.5"/><rect x="2" y="2" width="1" height="1" fill="%23333" opacity="0.3"/></svg>');
    opacity: 0.6;
    animation: static-flicker 0.15s steps(3) infinite;
  }
  @keyframes static-flicker {
    0% { transform: translate(0,0); }
    33% { transform: translate(-2px,1px); }
    66% { transform: translate(1px,-1px); }
    100% { transform: translate(0,0); }
  }
  .splash-overlay.hidden { opacity: 0; pointer-events: none; }
  .splash-logo {
    font-size: 2.5rem;
    font-weight: bold;
    color: #ffc107;
    letter-spacing: 6px;
    text-transform: uppercase;
    text-shadow: 0 0 30px rgba(255,193,7,0.6), 0 0 60px rgba(255,193,7,0.3);
    margin-bottom: 16px;
    z-index: 1;
  }
  .splash-spinner {
    width: 48px; height: 48px;
    border: 4px solid #333;
    border-top: 4px solid #ffc107;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
    z-index: 1;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }
  .splash-text {
    font-size: 1.1rem;
    color: #ccc;
    letter-spacing: 3px;
    text-transform: uppercase;
    z-index: 1;
  }
  .splash-text.active { color: #ffc107; text-shadow: 0 0 10px rgba(255,193,7,0.4); }

</style>
</head>
<body>

<div class="tv-frame" id="tvFrame">
  <video id="video" autoplay muted playsinline></video>
  <div class="crt-overlay"></div>
  <div class="crt-curve"></div>
  <div class="channel-badge" id="badge">{{CHANNEL_NAME}}</div>
  <div class="splash-overlay" id="splashOverlay">
    <div class="splash-logo">RetroVue</div>
    <div class="splash-spinner"></div>
    <div class="splash-text" id="splashText">Tuning in<span id="splashDots"></span></div>
  </div>
  <div class="unmute-overlay" id="unmuteOverlay">
    <div class="unmute-btn">ðŸ”Š</div>
  </div>
</div>

<div class="controls" id="channelList">
  {{CHANNEL_BUTTONS}}
</div>

<div class="status" id="status">Connecting...</div>

<script>
const channelId = '{{CHANNEL_ID}}';
const splash = document.getElementById('splashOverlay');
const splashText = document.getElementById('splashText');
const hlsUrl = '/'+'hls/'+channelId+'/'+'live.m3u8';
const video = document.getElementById('video');
const statusEl = document.getElementById('status');
const badge = document.getElementById('badge');
const unmuteOverlay = document.getElementById('unmuteOverlay');

setTimeout(() => badge.classList.add('fade'), 5000);

unmuteOverlay.addEventListener('click', () => {
  video.muted = false;
  unmuteOverlay.classList.add('hidden');
  statusEl.textContent = 'ðŸ”Š Audio on';
});

function startHLS() {
  if (Hls.isSupported()) {
    const hls = new Hls({
      liveSyncDurationCount: 2,
      liveMaxLatencyDurationCount: 3,
      enableWorker: true,
      lowLatencyMode: false,
    });
    hls.loadSource(hlsUrl);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      statusEl.textContent = 'Loading first segment...';
      splashText.textContent = 'Buffering...';
      splashText.className = 'splash-text active';
      statusEl.className = 'status buffering';
      // Don't play until we have actual data buffered
    });
    hls.on(Hls.Events.FRAG_LOADED, function onFirstFrag() {
      hls.off(Hls.Events.FRAG_LOADED, onFirstFrag);
      splashText.textContent = 'Buffering...';
      splashText.className = 'splash-text active';
      video.play().catch(() => {});
    });
    // Hide splash only when video actually has frames rendering
    video.addEventListener('playing', function onPlaying() {
      video.removeEventListener('playing', onPlaying);
      splash.classList.add('hidden');
      statusEl.textContent = 'â–² Tap screen for sound';
      statusEl.className = 'status';
    });
    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        statusEl.textContent = 'Stream error, retrying...';
        statusEl.className = 'status error';
        setTimeout(() => { hls.destroy(); startHLS(); }, 3000);
      }
    });
    hls.on(Hls.Events.FRAG_BUFFERED, () => {
      if (video.muted) {
        statusEl.textContent = 'â–² Tap screen for sound';
      }
      statusEl.className = 'status';
    });
    hls.on(Hls.Events.BUFFER_STALLED, () => {
      statusEl.textContent = 'Buffering...';
      statusEl.className = 'status buffering';
      // Re-show splash during mid-stream stalls
      splash.classList.remove('hidden');
      splashText.textContent = 'Buffering...';
      splashText.className = 'splash-text active';
    });
    // Hide splash again when playback resumes after stall
    video.addEventListener('playing', () => {
      splash.classList.add('hidden');
      statusEl.className = 'status';
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = hlsUrl;
    video.play().catch(() => {});
    statusEl.textContent = 'â–² Tap screen for sound';
  } else {
    statusEl.textContent = 'HLS not supported in this browser';
    statusEl.className = 'status error';
  }
}

function waitAndStart(attempts) {
  if (attempts <= 0) {
    statusEl.textContent = 'Stream not available. Is the channel on air?';
    statusEl.className = 'status error';
    return;
  }
  fetch(hlsUrl).then(r => {
    if (r.ok) { startHLS(); }
    else {
      statusEl.textContent = 'Waiting for stream... ('+attempts+')';
      splashText.textContent = 'Waiting for stream...';
      statusEl.className = 'status buffering';
      setTimeout(() => waitAndStart(attempts - 1), 2000);
    }
  }).catch(() => {
    statusEl.textContent = 'Waiting for stream... ('+attempts+')';
    statusEl.className = 'status buffering';
    setTimeout(() => waitAndStart(attempts - 1), 2000);
  });
}


// Animated dots on splash text
const splashDots = document.getElementById('splashDots');
let dotCount = 0;
const dotInterval = setInterval(() => {
  dotCount = (dotCount % 3) + 1;
  if (splashDots) splashDots.textContent = '.'.repeat(dotCount);
}, 500);

waitAndStart(30);
</script>
</body>
</html>
