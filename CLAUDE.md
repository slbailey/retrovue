# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

RetroVue is a multi-component application for simulating broadcast television channels with real-time playout and scheduling. The system process is `retrovue`. The system only spins up real video processing (ffmpeg) when viewers are actively watching.

## Environment and build paths (mandatory)

- **Python:** Always use the virtualenv at **`pkg/core/.venv`**. Before any `python`, `pytest`, or `pip` for this repo, activate it:
  ```bash
  source /opt/retrovue/pkg/core/.venv/bin/activate
  ```
  Or from repo root: `source pkg/core/.venv/bin/activate`. Do not run system `python`/`pytest` for Core code.

- **C++ (Air):** Build output **must** go in **`pkg/air/build`**. Configure and build exactly like this:
  ```bash
  cmake -S pkg/air -B pkg/air/build -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DCMAKE_BUILD_TYPE=RelWithDebInfo
  cmake --build pkg/air/build -j$(nproc)
  ```
  Do not use a different build directory (e.g. not `pkg/air/build-asan` for default builds; not a top-level `build/`).

- **Proto:** There is a **single canonical** definition: **`protos/playout.proto`** (repo root). No other copy. Generated Python stubs live in **`pkg/core/core/proto/retrovue/`**. Regenerate with (from repo root): `sh scripts/air/generate_proto.sh`. C++ stubs are generated by Air’s CMake from the same file.

## Build and Test Commands

### Python Core (pkg/core/)

**Activate the venv first** (see above). Then, from repo root:

```bash
# Install dependencies (with venv active)
pip install -r pkg/core/requirements.txt

# Run all tests
pytest pkg/core/tests/

# Run a single test file
pytest pkg/core/tests/contracts/test_source_add_contract.py -vv

# Run contract tests only
pytest pkg/core/tests/contracts -vv

# Lint
ruff check pkg/core/src/
mypy pkg/core/src/
```

### Internal Playout Engine (pkg/air/)

```bash
# Install vcpkg dependencies
sh pkg/air/INSTALL_VCPKG_PACKAGES.sh

# Generate protobuf code (from repo root; Python stubs → pkg/core/core/proto/retrovue/)
sh scripts/air/generate_proto.sh

# Configure and build (output MUST be pkg/air/build)
cmake -S pkg/air -B pkg/air/build -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DCMAKE_BUILD_TYPE=RelWithDebInfo
cmake --build pkg/air/build -j$(nproc)

# Run tests
ctest --test-dir pkg/air/build --output-on-failure

# Note: The playout engine is an internal component and should not be run independently
```

### Database Setup

Tests require PostgreSQL. Run migrations before testing:
```bash
cd pkg/core && alembic upgrade head
```

## Architecture

### Two-Package Structure

- **Core (Python)**: Orchestration, scheduling, state management, CLI. Entry point: `retrovue` CLI via `pkg/core/src/retrovue/cli/main.py`
- **Internal playout engine (C++)**: Real-time decode/render/playout engine. Communicates with Core via gRPC defined in `protos/playout.proto`

### Core Runtime Flow

1. **MasterClock** - Single authoritative time source for scheduling and playout
2. **ScheduleService** - Answers "what should be airing now?" for each channel
3. **ChannelManager** - Per-channel orchestration; starts/stops Producers; calls the internal playout engine via gRPC
4. **ProgramDirector** - The control plane inside RetroVue; system-wide coordination and policy (normal/emergency modes)
5. **AsRunLogger** - Records what actually aired for compliance

### Internal Playout Engine Pipeline

1. **PlayoutEngine** (gRPC control plane) - Channel lifecycle via StartChannel/UpdatePlan/StopChannel
2. **Producers** - Decode assets using FFmpeg/libav
3. **FrameRingBuffer** - Lock-free staging between decode and render
4. **Renderer** - Converts frames to renderable output
5. **MPEG-TS sinks** - Emit continuous streams with pacing/backpressure

### Domain Entities (Core)

Key models in `pkg/core/src/retrovue/domain/`: Source, Collection, Asset, Enricher, Channel, Program, Zone, SchedulePlan, ScheduleDay, Playlist, PlaylogEvent

## Contract-First Development

This codebase uses contract-first development. For every CLI command or usecase:

1. Update the contract doc in `docs/core/contracts/resources/` first
2. Write/update contract tests to match documented behavior
3. Then modify application code

Contract tests exist in pairs:
- `<command>_contract.py` - CLI behavior (args, exit codes, output)
- `<command>_data_contract.py` - Database state changes

## Key Documentation Entry Points

- `docs/ComponentMap.md` - Cross-repo component list and interfaces
- `docs/core/README.md` - Core (Python) documentation index
- `pkg/air/docs/README.md` - Internal playout engine (C++) documentation index
- `docs/core/architecture/ArchitectureOverview.md` - System mental model
- `docs/core/contracts/resources/README.md` - CLI/usecase contract index

## Code Layout Conventions

### Python (Core)
- Source: `pkg/core/src/retrovue/`
- CLI commands: `pkg/core/src/retrovue/cli/commands/`
- Usecases: `pkg/core/src/retrovue/usecases/`
- Domain models: `pkg/core/src/retrovue/domain/`
- Tests: `pkg/core/tests/`

### C++ (Internal playout engine)
- Public headers: `pkg/air/include/retrovue/<module>/`
- Implementation: `pkg/air/src/<module>/`
- Tests: `pkg/air/tests/`
- Namespaces mirror directory structure (e.g., `retrovue::buffer`)

## Shell Environment

- Development uses WSL/Ubuntu with bash
- Scripts use `.sh` extension and should be POSIX-compliant where possible
- All scripts must be executable: `chmod +x script.sh`
