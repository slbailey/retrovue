# Playlog Event Contract

_Related: [Domain: PlaylogEvent](../../domain/PlaylogEvent.md) • [Domain: ScheduleDay](../../domain/ScheduleDay.md) • [Domain: Asset](../../domain/Asset.md) • [ScheduleDayContract](ScheduleDayContract.md) • [Runtime: Channel Manager](../../runtime/ChannelManager.md)_

## Purpose

Define the behavioral contract for BroadcastPlaylogEvent operations in RetroVue. BroadcastPlaylogEvent is the lowest runtime layer — a log of exactly what was played and when. These events represent the execution-level playout schedule derived from BroadcastScheduleDay, providing precise timing and content references for ChannelManager and Producers.

---

## Command Shape

### List Playlog Events

```
retrovue playlog-event list \
  [--channel-id <uuid>] \
  [--date <YYYY-MM-DD>] \
  [--date-range <start:end>] \
  [--start-time <HH:MM:SS>] \
  [--end-time <HH:MM:SS>] \
  [--json] [--test-db]
```

### Show Playlog Event

```
retrovue playlog-event show \
  --id <uuid> | --event-uuid <uuid> \
  [--json] [--test-db]
```

### Query Playlog Events

```
retrovue playlog-event query \
  --channel-id <uuid> \
  --at-time <YYYY-MM-DDTHH:MM:SSZ> \
  [--json] [--test-db]
```

### Validate Playlog Events

```
retrovue playlog-event validate \
  --channel-id <uuid> \
  --date <YYYY-MM-DD> \
  [--json] [--test-db]
```

---

## Parameters

### List Parameters

- `--channel-id` (optional): Filter by channel UUID
- `--date` (optional): Filter by broadcast date (YYYY-MM-DD)
- `--date-range` (optional): Filter by date range (format: "YYYY-MM-DD:YYYY-MM-DD")
- `--start-time` (optional): Filter events starting at or after this UTC time (HH:MM:SS)
- `--end-time` (optional): Filter events ending at or before this UTC time (HH:MM:SS)
- `--json` (optional): Machine-readable output
- `--test-db` (optional): Use isolated test database session

### Show Parameters

- `--id` or `--event-uuid` (required): Integer ID or UUID of the PlaylogEvent
- `--json` (optional): Machine-readable output
- `--test-db` (optional): Use isolated test database session

### Query Parameters

- `--channel-id` (required): UUID of the Channel
- `--at-time` (required): UTC timestamp in ISO format (YYYY-MM-DDTHH:MM:SSZ)
- `--json` (optional): Machine-readable output
- `--test-db` (optional): Use isolated test database session

### Validate Parameters

- `--channel-id` (required): UUID of the Channel
- `--date` (required): Broadcast date in "YYYY-MM-DD" format
- `--json` (optional): Machine-readable output
- `--test-db` (optional): Use isolated test database session

---

## Safety Expectations

- **List**: Read-only query of playlog events. No side effects.
- **Show**: Read-only display of specific playlog event. No side effects.
- **Query**: Read-only query for events at a specific time. No side effects.
- **Validate**: Read-only validation of playlog events for a channel and date. Reports gaps and alignment issues.
- **No mutations**: Playlog events are generated by ScheduleService, not manually created or modified by operators.
- `--test-db` MUST isolate from production data.

---

## Output Format

### Human-Readable (List)

```
Playlog Events (Channel: RetroVue-1, Date: 2025-01-15):
  
  Event 1:
    ID: 12345
    UUID: 550e8400-e29b-41d4-a716-446655440000
    Asset: Tom & Jerry - Episode 1
    Start (UTC): 2025-01-15T06:00:00Z
    End (UTC): 2025-01-15T06:30:00Z
    Duration: 30:00
    Broadcast Day: 2025-01-15

  Event 2:
    ID: 12346
    UUID: 660e8400-e29b-41d4-a716-446655440001
    Asset: SpongeBob SquarePants - Episode 42
    Start (UTC): 2025-01-15T06:30:00Z
    End (UTC): 2025-01-15T07:00:00Z
    Duration: 30:00
    Broadcast Day: 2025-01-15

  Gap detected: 07:00:00Z - 07:15:00Z (15 minutes)
```

### JSON (List)

```json
{
  "status": "ok",
  "events": [
    {
      "id": 12345,
      "uuid": "550e8400-e29b-41d4-a716-446655440000",
      "channel_id": "123e4567-e89b-12d3-a456-426614174000",
      "channel_name": "RetroVue-1",
      "asset_uuid": "789e0123-e45b-67c8-d901-234567890abc",
      "asset_title": "Tom & Jerry - Episode 1",
      "start_utc": "2025-01-15T06:00:00Z",
      "end_utc": "2025-01-15T06:30:00Z",
      "duration_seconds": 1800,
      "broadcast_day": "2025-01-15",
      "created_at": "2025-01-01T12:00:00Z"
    }
  ],
  "gaps": [
    {
      "start_utc": "2025-01-15T07:00:00Z",
      "end_utc": "2025-01-15T07:15:00Z",
      "duration_seconds": 900
    }
  ],
  "total_events": 2,
  "total_gaps": 1
}
```

### Human-Readable (Query)

```
Playlog Event at 2025-01-15T06:45:00Z:
  ID: 12345
  Asset: Tom & Jerry - Episode 1
  Start (UTC): 2025-01-15T06:00:00Z
  End (UTC): 2025-01-15T06:30:00Z
  Status: Event ended (15 minutes ago)
  
  Next Event:
    Asset: SpongeBob SquarePants - Episode 42
    Start (UTC): 2025-01-15T06:30:00Z
    End (UTC): 2025-01-15T07:00:00Z
    Status: Event active (15 minutes remaining)
```

---

## Exit Codes

- `0`: Operation completed successfully
- `1`: Validation failed, query error, or invalid parameters

---

## Behavior Contract Rules (L-#)

### ScheduleDay Alignment

- **L-1:** Playlog events MUST align with BroadcastScheduleDay records
- **L-2:** Each PlaylogEvent MUST correspond to a content assignment in the ScheduleDay
- **L-3:** Playlog events for a channel and date MUST reference the same ScheduleDay
- **L-4:** Playlog events MUST share the same `channel_id` and `broadcast_day` as their parent ScheduleDay
- **L-5:** Playlog events MUST be generated from ScheduleDay content selections
- **L-6:** If ScheduleDay is regenerated, existing PlaylogEvents for that (channel_id, schedule_date) MUST be deleted and regenerated
- **L-7:** Playlog events MUST NOT exist without a corresponding ScheduleDay
- **L-8:** Validation MUST verify alignment between PlaylogEvents and ScheduleDay

### Absolute Start Times

- **L-9:** Playlog event `start_utc` MUST be an absolute UTC timestamp (e.g., "2025-01-15T16:00:00Z")
- **L-10:** Start times MUST be timezone-aware (include timezone information)
- **L-11:** Start times MUST be precise to the second (format: YYYY-MM-DDTHH:MM:SSZ)
- **L-12:** Start times MUST align with wall-clock time (not relative or offset-based)
- **L-13:** Start times MUST be stored as DateTime(timezone=True) in UTC
- **L-14:** Start time validation MUST reject naive datetime objects (timezone-unaware)
- **L-15:** Start times MUST be monotonically increasing within a channel (no backwards time travel)

### Duration Calculation

- **L-16:** Playlog event duration MUST be calculable from asset content length
- **L-17:** Duration MUST equal `end_utc - start_utc` (duration in seconds)
- **L-18:** Duration MUST match the asset's `duration_ms` converted to seconds (within tolerance)
- **L-19:** Duration tolerance MUST account for rounding and precision (e.g., ±1 second)
- **L-20:** If asset duration is unknown or invalid, PlaylogEvent generation MUST fail
- **L-21:** Duration calculation MUST use asset metadata from the Asset table
- **L-22:** Duration validation MUST verify `end_utc - start_utc` matches expected asset duration
- **L-23:** Playlog events MUST have `end_utc > start_utc` (positive duration)

### Gaps Between Events

- **L-24:** Gaps between PlaylogEvents MUST be explicitly allowed
- **L-25:** Gaps are defined as time periods with no PlaylogEvent coverage
- **L-26:** Gaps MUST NOT prevent PlaylogEvent generation (gaps are warnings, not errors)
- **L-27:** Gap detection MUST identify time periods between consecutive events where `previous_event.end_utc < next_event.start_utc`
- **L-28:** Gaps within broadcast day (00:00-24:00) SHOULD be flagged as warnings
- **L-29:** Gaps are handled by fallback producer modules (e.g., EmergencyProducer, TestPatternProducer)
- **L-30:** ChannelManager MUST use fallback producers when querying for events during gaps
- **L-31:** Gap warnings MUST identify the time period and duration
- **L-32:** Gaps at broadcast day boundaries are expected and not warnings

### Fallback Producer Modules

- **L-33:** Fallback producer modules MUST be respected when PlaylogEvents are missing
- **L-34:** When ChannelManager queries for a PlaylogEvent at a specific time and none exists, fallback producers MUST be used
- **L-35:** Fallback producers (e.g., EmergencyProducer, TestPatternProducer) MUST handle gap periods
- **L-36:** Fallback producers MUST generate playout plans when no PlaylogEvent covers the requested time
- **L-37:** Fallback producer selection MUST be configurable per channel
- **L-38:** Fallback producers MUST NOT override valid PlaylogEvents (only fill gaps)
- **L-39:** Fallback producer usage MUST be logged for audit purposes
- **L-40:** If fallback producer fails, system MUST attempt next fallback or log error

### Event Generation

- **L-41:** PlaylogEvents MUST be generated automatically by ScheduleService during ScheduleDay creation
- **L-42:** PlaylogEvent generation MUST occur in the same transaction as ScheduleDay creation
- **L-43:** If PlaylogEvent generation fails, ScheduleDay creation MUST rollback
- **L-44:** PlaylogEvents MUST reference valid Asset records with `state='ready'` and `approved_for_broadcast=true`
- **L-45:** PlaylogEvents MUST NOT reference assets in `new`, `enriching`, or `retired` states
- **L-46:** PlaylogEvent generation MUST validate asset eligibility before creating events

### Event Sequencing

- **L-47:** PlaylogEvents for a channel MUST be ordered by `start_utc` (chronological)
- **L-48:** Consecutive events MUST NOT overlap (next event `start_utc` >= previous event `end_utc`)
- **L-49:** Overlapping events MUST be detected and reported as errors
- **L-50:** Events MAY have gaps between them (allowed, handled by fallback producers)
- **L-51:** Events MUST NOT have negative gaps (overlaps)

### Broadcast Day Alignment

- **L-52:** PlaylogEvent `broadcast_day` MUST match the ScheduleDay's `schedule_date`
- **L-53:** Broadcast day MUST be in "YYYY-MM-DD" format
- **L-54:** Broadcast day MUST be calculated using ScheduleService.broadcast_day_for() logic
- **L-55:** Events that span broadcast day boundaries MUST be split into multiple events (one per broadcast day)

### Referential Integrity

- **L-56:** `channel_id` MUST reference an existing Channel
- **L-57:** `asset_uuid` MUST reference an existing Asset
- **L-58:** Asset MUST be in `ready` state with `approved_for_broadcast=true`
- **L-59:** Foreign key constraints MUST enforce referential integrity
- **L-60:** Deleting a ScheduleDay SHOULD cascade delete associated PlaylogEvents (or prevent deletion)

### Query Operations

- **L-61:** Query at time MUST return the PlaylogEvent that covers the requested time (if any)
- **L-62:** Query at time MUST return null/gap if no event covers the requested time
- **L-63:** Query at time MUST handle edge cases (exactly at start_utc, exactly at end_utc)
- **L-64:** Query MUST return events where `start_utc <= query_time < end_utc`
- **L-65:** Query MUST handle timezone-aware timestamps correctly

### Validation

- **L-66:** Validate command MUST check alignment with ScheduleDay
- **L-67:** Validate command MUST detect gaps and report them as warnings
- **L-68:** Validate command MUST detect overlaps and report them as errors
- **L-69:** Validate command MUST verify duration calculations
- **L-70:** Validate command MUST verify asset eligibility
- **L-71:** Validate command MUST verify referential integrity

### Output Format

- **L-72:** `--json` flag MUST return valid JSON with the operation result
- **L-73:** Human-readable output MUST include all event fields (id, uuid, channel, asset, times, duration, broadcast_day)
- **L-74:** List command MUST show events in chronological order
- **L-75:** Gap information MUST be included in list output when gaps exist

### Test Database

- **L-76:** `--test-db` flag MUST behave identically in output shape and exit codes
- **L-77:** `--test-db` MUST NOT read/write production tables

---

## Data Contract Rules (D-#)

### Persistence

- **D-1:** Playlog event records MUST be persisted in `broadcast_playlog_events` table
- **D-2:** Timestamps MUST be stored in UTC with timezone information
- **D-3:** `channel_id` MUST be stored as Integer foreign key reference
- **D-4:** `asset_uuid` MUST be stored as UUID foreign key reference
- **D-5:** `start_utc` MUST be stored as DateTime(timezone=True) in UTC
- **D-6:** `end_utc` MUST be stored as DateTime(timezone=True) in UTC
- **D-7:** `broadcast_day` MUST be stored as TEXT in "YYYY-MM-DD" format
- **D-8:** `uuid` MUST be stored as UUID with unique constraint
- **D-9:** Database indexes MUST exist on (channel_id, start_utc), broadcast_day, and asset_uuid for efficient queries

### Referential Integrity

- **D-10:** Foreign key constraints MUST ensure channel_id references valid Channel
- **D-11:** Foreign key constraints MUST ensure asset_uuid references valid Asset
- **D-12:** Deleting a channel SHOULD handle dependent playlog events (CASCADE or RESTRICT based on schema)
- **D-13:** Deleting an asset SHOULD prevent deletion if referenced by playlog events (RESTRICT)

### Transaction Boundaries

- **D-14:** Playlog event generation MUST occur within a single database transaction with ScheduleDay creation
- **D-15:** Transaction MUST rollback on any validation failure
- **D-16:** Test database operations MUST use isolated transactions

### Immutability

- **D-17:** Playlog events SHOULD be immutable after creation (read-only)
- **D-18:** If updates are allowed at database level, application layer MUST enforce immutability for runtime events
- **D-19:** Regeneration of ScheduleDay MUST delete and recreate PlaylogEvents (not modify existing)

---

## Tests

Planned tests:

- `tests/contracts/test_playlog_event_list_contract.py::test_playlog_event_list__by_channel`
- `tests/contracts/test_playlog_event_list_contract.py::test_playlog_event_list__by_date`
- `tests/contracts/test_playlog_event_list_contract.py::test_playlog_event_list__with_gaps`
- `tests/contracts/test_playlog_event_show_contract.py::test_playlog_event_show__by_id`
- `tests/contracts/test_playlog_event_show_contract.py::test_playlog_event_show__by_uuid`
- `tests/contracts/test_playlog_event_query_contract.py::test_playlog_event_query__finds_active_event`
- `tests/contracts/test_playlog_event_query_contract.py::test_playlog_event_query__finds_gap`
- `tests/contracts/test_playlog_event_query_contract.py::test_playlog_event_query__edge_cases`
- `tests/contracts/test_playlog_event_validate_contract.py::test_playlog_event_validate__alignment_with_schedule_day`
- `tests/contracts/test_playlog_event_validate_contract.py::test_playlog_event_validate__detects_gaps`
- `tests/contracts/test_playlog_event_validate_contract.py::test_playlog_event_validate__detects_overlaps`
- `tests/contracts/test_playlog_event_validate_contract.py::test_playlog_event_validate__duration_calculation`
- `tests/contracts/test_playlog_event_validate_contract.py::test_playlog_event_validate__asset_eligibility`

---

## Error Conditions

### Validation Errors

- Event not found: exit 1, "Error: Playlog event not found."
- Channel not found: exit 1, "Error: Channel not found."
- Asset not found: exit 1, "Error: Asset not found."
- Invalid time format: exit 1, "Error: Invalid time format. Expected ISO 8601 (YYYY-MM-DDTHH:MM:SSZ)."
- Overlapping events: exit 1, "Error: Overlapping playlog events detected."
- Asset not eligible: exit 1, "Error: Asset is not eligible for playout (not ready or not approved)."

---

## Gap and Fallback Examples

### Example 1: Gap Between Events

```
Event 1: 06:00:00Z - 06:30:00Z (Tom & Jerry)
Gap: 06:30:00Z - 07:00:00Z (30 minutes)
Event 2: 07:00:00Z - 07:30:00Z (SpongeBob)
```

**Result:** Gap is detected and reported as warning. Fallback producer (e.g., TestPatternProducer) handles 06:30-07:00 period.

### Example 2: Fallback Producer Usage

```
ChannelManager queries: "What's playing at 06:45:00Z?"
PlaylogEvent query: No event found (gap period)
Fallback: EmergencyProducer activated
Result: Test pattern or standby screen plays
```

**Result:** Fallback producer generates playout plan for gap period. Event is logged for audit.

### Example 3: Broadcast Day Boundary

```
Event 1: 05:30:00Z - 06:00:00Z (broadcast_day: 2025-01-14)
Event 2: 06:00:00Z - 06:30:00Z (broadcast_day: 2025-01-15)
```

**Result:** Events are correctly split across broadcast day boundary. No gap warning (boundary is expected).

---

## See also

- [Domain: PlaylogEvent](../../domain/PlaylogEvent.md) - Complete domain documentation
- [Domain: ScheduleDay](../../domain/ScheduleDay.md) - Parent schedule day entity
- [Domain: Asset](../../domain/Asset.md) - Referenced asset content
- [ScheduleDayContract](ScheduleDayContract.md) - Schedule day operations
- [Runtime: Channel Manager](../../runtime/ChannelManager.md) - Runtime execution
- [Runtime: Producer Lifecycle](../../runtime/ProducerLifecycle.md) - Producer modules
- [CLI Data Guarantees](cross-domain/CLI_Data_Guarantees.md) - General CLI guarantees

