Task ID: P8-INT-001
Rule ID: INV-P8-SEGMENT-EOF-DISTINCT-001, INV-P8-CONTENT-DEFICIT-FILL-001, INV-P8-FRAME-COUNT-PLANNING-AUTHORITY-001
Governing Law: LAW-OUTPUT-LIVENESS, LAW-SWITCHING
Subsystem: AIR (Full playout chain)
Task Type: INTEGRATION TEST
File(s) to Modify: pkg/air/tests/integration/test_playout_integration.cpp
Owner: AIR
Blocked By: P8-TEST-FILL-003

Instructions:
- Add integration test: short content → pad → switch
- Verify full playout chain handles content deficit
- Verify seamless playback: content → pad → next segment
- Verify no black screen incident

---

Governing Principle (LAW-OUTPUT-LIVENESS):
> ProgramOutput never blocks; if no content → deterministic pad (black + silence).

Rule Definition:
This integration test validates the entire content deficit flow end-to-end, preventing the black screen incident observed in production.

Test Scenario:

1. **Setup:**
   - Channel with two segments: A (short), B (normal)
   - Segment A: legacy preload RPC frame_count=300, actual content=200 frames
   - Segment B: Normal content
   - Boundary at T+10s (300 frames at 30fps)

2. **Execution:**
   - Start playout
   - Content A plays (200 frames, ~6.67s)
   - Decoder EOF at T+6.67s
   - Content deficit fill activates
   - Pad frames emit until T+10s
   - Switch to segment B at T+10s
   - Content B plays normally

3. **Verification Points:**
   - T+0s: First content frame from A
   - T+6.67s: DECODER_EOF logged; EARLY_EOF logged; CONTENT_DEFICIT_FILL_START logged
   - T+6.67s to T+10s: Pad frames at 30fps; TS cadence preserved
   - T+10s: Switch; CONTENT_DEFICIT_FILL_END logged; first content frame from B
   - Throughout: CT monotonic; no gaps; no timeline corruption

4. **Observable Proof:**
   - Log sequence: DECODER_EOF → EARLY_EOF → CONTENT_DEFICIT_FILL_START → (pad frames) → CONTENT_DEFICIT_FILL_END
   - TS stream continuous
   - Viewer would see: content → black → content (no disconnect)

5. **Failure Reproduction:**
   Without this fix, the scenario would cause:
   - Buffer empty → no TS packets → HTTP timeout → false viewer disconnect → teardown
   This test verifies that failure mode is prevented.

Done Criteria:
Full chain: content → pad → switch; no black screen; TS cadence preserved; all logs present; seamless playback.
