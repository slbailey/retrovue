Task ID: P1-PO-005
Rule ID: INV-AIR-CONTENT-BEFORE-PAD
Subsystem: ProgramOutput
Task Type: VERIFY + TEST (add test when verification fails)
File(s) to Modify: pkg/air/tests/contracts/PrimitiveInvariants/PacingInvariantContractTests.cpp
Test or Log Name: INV_AIR_CONTENT_BEFORE_PAD

Instructions:
- VERIFY: Review existing test coverage; report pass/fail.
- If verification fails: add contract test as part of this task (no separate follow-on).

---

Rule Definition:
Pad frames may only be emitted after the first real decoded content frame has been routed to output. This prevents a pad-only loop at startup.

Verification Checklist:
1. [x] Locate existing tests for CONTENT-BEFORE-PAD gate
2. [x] Confirm test verifies pad is NOT emitted before real content
3. [x] Confirm test verifies pad IS emitted after real content when buffer empties
4. [x] Confirm zero-frame segment bypass (INV-P8-ZERO-FRAME-BOOTSTRAP) is tested separately

Files Reviewed:
- pkg/air/tests/contracts/PrimitiveInvariants/PacingInvariantContractTests.cpp
- pkg/air/tests/contracts/Phase10PipelineFlowControlTests.cpp
- pkg/air/src/renderer/ProgramOutput.cpp

---

Verification Result: **FAIL**

Evidence:

1. **CONTENT-BEFORE-PAD gate implementation**
   - ProgramOutput.cpp lines 328–339: When Pop fails, if `!first_real_frame_emitted_ && !no_content_segment_`, the loop continues without emitting pad.
   - ProgramOutput.cpp lines 677–686: When a real frame is routed, `first_real_frame_emitted_ = true` opens the gate.
   - Gate logic exists and is correct.

2. **Existing tests did NOT explicitly cover the gate**
   - INV_STARVATION_FAILSAFE_001: Uses `SetNoContentSegment(true)` → bypasses gate; tests pad emission for zero-frame segment.
   - TEST_INV_P8_ZERO_FRAME_BOOTSTRAP: Uses `SetNoContentSegment(true)` → bypasses gate.
   - INV_PACING_002_FreezeFrameEmittedOnBufferStarvation: Starts with real content; implicitly exercises "pad after real" but does not assert (a) no pad before first real frame, or (b) pad explicitly emitted after real content when buffer empties.
   - FE_002_HeadlessRendererHandlesEmptyBufferGracefully: Empty buffer, no SetNoContentSegment, but expects frames_skipped > 0; ProgramOutput does not increment frames_skipped. Does not assert no pad frames.

3. **Zero-frame bypass (INV-P8-ZERO-FRAME-BOOTSTRAP)**
   - Tested separately in TEST_INV_P8_ZERO_FRAME_BOOTSTRAP_EndToEndOutputFlows ✓

4. **Remediation (part of this task)**
   - Added test `INV_AIR_CONTENT_BEFORE_PAD` in PacingInvariantContractTests.cpp.
   - Phase 1: Empty buffer, no SetNoContentSegment, 200ms run → assert frames_rendered == 0 and zero frames at side sink.
   - Phase 2: Buffer with 2 real frames, 500ms run → assert first frame(s) not pad, at least one pad frame after drain.
   - INV-AIR-CONTENT-BEFORE-PAD added to CoveredRuleIds and RegisterExpectedDomainCoverage.

Done Criteria:
**Complete:** Verification failed; test added as part of P1-PO-005. Gate now covered: (1) no pad before first real frame when buffer empty, (2) pad emitted after real content when buffer empties.
