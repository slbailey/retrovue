Task ID: P1-MS-006
Rule ID: INV-P9-TS-EMISSION-LIVENESS
Subsystem: MpegTSOutputSink
Task Type: LOG
File(s) to Modify: pkg/air/src/output/MpegTSOutputSink.cpp
Test or Log Name: INV-P9-TS-EMISSION-LIVENESS violation log

Instructions:
- Implement exactly one atomic task
- Modify ONLY the listed file(s)
- Do not refactor
- Do not add tests unless explicitly requested
- Do not change production behavior
- Stop immediately after log is added

---

Rule Definition:
First decodable TS packet MUST be emitted within 500ms of PCR-PACE timing initialization. Violation must be logged with diagnostic information.

Log Specification:
When 500ms elapses without first TS bytes being written, log a violation with blocking reason and queue depths.

Log Format:
```
[MpegTSOutputSink] INV-P9-TS-EMISSION-LIVENESS VIOLATION: No TS after %dms, blocking_reason=%s, vq=%d, aq=%d
```

Log Level: WARNING (invariant violation)

Location:
In the mux loop or timing check, when elapsed time exceeds 500ms and bytes_written is still 0. May require adding a periodic check or timer.

Required Fields:
- elapsed_ms: time from PCR-PACE init
- blocking_reason: one of "audio", "video", "encoder" based on queue state
- vq: video queue depth
- aq: audio queue depth

Blocking Reason Logic:
- If aq == 0 and vq > 0: blocking_reason = "audio"
- If vq == 0 and aq > 0: blocking_reason = "video"
- If vq == 0 and aq == 0: blocking_reason = "encoder"
- Otherwise: blocking_reason = "unknown"

Constraints:
- Add exactly one log statement (may need timer/check logic)
- Requires PCR-PACE init timestamp from P1-MS-004
- Log only once per session (use flag to prevent spam)
- Do not modify control flow beyond adding the check
- Use existing logging macros/patterns in the codebase

Done Criteria:
Log `INV-P9-TS-EMISSION-LIVENESS VIOLATION: No TS after {X}ms, blocking_reason={...}, vq={N}, aq={M}` emitted when 500ms deadline exceeded.

---

## Completion

- **Status:** Done
- **Completed:** 2026-02-01
- **Implementation:** Violation check added in MuxLoop when `timing_initialized` and elapsed >= 500ms and `dbg_bytes_written_ == 0`; blocking_reason from vq/aq; logged once per session via `g_ts_emission_violation_logged`.
