Task ID: P12-CORE-002
Rule ID: INV-TEARDOWN-STABLE-STATE-001, INV-VIEWER-COUNT-ADVISORY-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P12-CORE-001

Instructions:
- Implement `_request_teardown(reason: str) -> bool` method
- Check `_boundary_state` against `_STABLE_STATES`
- If stable: return True (caller may proceed)
- If transient: set pending state, compute deadline, return False
- Make method idempotent (second call while pending is no-op)

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-STABLE-STATE-001):
Teardown due to viewer inactivity MUST be deferred until `_boundary_state` is stable.

Rule Definition (INV-VIEWER-COUNT-ADVISORY-001):
Viewer count is advisory, not authoritative, for teardown during transient states. Zero viewers MUST trigger (not force) teardown request.

Implementation:

1. Add `_request_teardown(self, reason: str) -> bool` method:
   - If `_teardown_pending` already True: log debug "teardown already pending", return False (idempotent)
   - If `_boundary_state in _STABLE_STATES`: log info, return True
   - Else (transient state):
     - Set `_teardown_pending = True`
     - Set `_teardown_deadline = self.clock.now_utc() + _TEARDOWN_GRACE_TIMEOUT`
     - Set `_teardown_reason = reason`
     - Log warning with state, reason, deadline
     - Return False

2. Logging format:
   - Stable: `"INV-TEARDOWN-STABLE-STATE-001: Teardown permitted (state=%s, reason=%s)"`
   - Deferred: `"INV-TEARDOWN-STABLE-STATE-001: Teardown DEFERRED (state=%s, reason=%s, deadline=%s)"`

Constraints:
- MUST use `self.clock.now_utc()` for deadline computation (testable clock)
- MUST be idempotent (multiple calls don't extend deadline)
- MUST NOT execute any teardown logic itself (just returns permission)

Done Criteria:
`_request_teardown()` correctly distinguishes stable vs transient; returns appropriate boolean; sets pending state with deadline when deferred.

---

## Completion

**Completed:** 2025-02-02

**Changes:**
- **pkg/core/src/retrovue/runtime/channel_manager.py**
  - Added `_request_teardown(self, reason: str) -> bool`:
    - If `_teardown_pending`: log debug, return False (idempotent).
    - If `_boundary_state in _STABLE_STATES`: log info "Teardown permitted", return True.
    - Else (transient): set `_teardown_pending`, `_teardown_deadline = clock.now_utc() + _TEARDOWN_GRACE_TIMEOUT`, `_teardown_reason`; log warning "Teardown DEFERRED"; return False.
  - Uses `self.clock.now_utc()` for deadline; does not execute teardown.

**Tests:**
- **pkg/core/tests/runtime/test_p12_teardown_scaffolding.py**
  - `test_request_teardown_stable_returns_true`: parametrized over _STABLE_STATES → returns True, no pending.
  - `test_request_teardown_transient_defers`: parametrized over _TRANSIENT_STATES → returns False, pending/deadline/reason set, deadline = now + 10s.
  - `test_request_teardown_idempotent`: second call while pending returns False, deadline unchanged.
- All 83 runtime tests pass.
