Task ID: P12-CORE-006
Rule ID: INV-VIEWER-COUNT-ADVISORY-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ProgramDirector
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/program_director.py
Owner: Core
Blocked By: P12-CORE-002

Instructions:
- Modify viewer disconnect handler to use `_request_teardown()`
- If request returns True: proceed with channel destruction
- If request returns False: defer destruction, register callback or poll
- Handle deferred teardown completion signal from ChannelManager

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-VIEWER-COUNT-ADVISORY-001):
Viewer count is advisory, not authoritative, for teardown during transient states. Zero viewers MUST trigger (not force) teardown request.

Implementation:

1. Modify viewer disconnect handler (when `viewer_count == 0`):
   - Call `manager._request_teardown(reason="viewer_inactive")`
   - If returns True: proceed with existing `_destroy_channel_manager()` logic
   - If returns False: log info "teardown deferred for channel %s", do NOT destroy

2. Handle deferred teardown completion:
   - Option A: ChannelManager exposes `teardown_ready` property; ProgramDirector polls on tick
   - Option B: ChannelManager calls registered callback when deferred teardown executes
   - Option C: ChannelManager directly calls ProgramDirector method
   - Implement whichever integrates cleanly with existing architecture

3. When deferred teardown becomes ready:
   - ProgramDirector receives signal
   - Calls `_destroy_channel_manager()` as normal
   - Channel cleanup proceeds

Constraints:
- MUST NOT bypass `_request_teardown()` for any viewer-driven teardown
- MUST handle rapid disconnect/reconnect gracefully
- MUST NOT leak channels (deferred teardown must eventually complete)

Edge Cases:
- Viewer reconnects while teardown pending: future consideration (not in Phase 12 scope)
- Multiple rapid disconnects: `_request_teardown()` is idempotent
- ProgramDirector shutdown while channel has deferred teardown: force cleanup

Done Criteria:
Viewer disconnect routes through `_request_teardown()`; immediate vs deferred teardown handled correctly; no orphaned channels.

---

## Completion

**Completed:** 2025-02-02

**Changes (pkg/core/src/retrovue/runtime/program_director.py):**
- **Viewer disconnect** (`_run_stream_cleanup`): when last viewer leaves (`to_stop`), call `manager._request_teardown(reason="viewer_inactive")`. If True: `self.stop_channel(channel_id)`. If False: log "Teardown deferred for channel %s (transient boundary state)", do not destroy.
- **Deferred completion:** In `_health_check_loop`, after `check_health()` and `tick()` for each manager, check `manager.deferred_teardown_triggered()`. If True, collect `channel_id`; after the loop, call `_stop_channel_internal(channel_id)` for each. ChannelManager clears `_deferred_teardown_triggered` when `stop_channel()` is called during destroy.
- No bypass of `_request_teardown()` for viewer-driven teardown; rapid disconnect/reconnect handled by idempotent `_request_teardown()`.
