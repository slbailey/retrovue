Task ID: P12-CORE-005
Rule ID: INV-TEARDOWN-NO-NEW-WORK-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P12-CORE-002

Instructions:
- Add guard in `tick()` to skip boundary work when teardown pending
- Add guard in any method that schedules new legacy preload RPC or legacy switch RPC
- Do NOT block in-flight operations (only prevent NEW work)

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-NO-NEW-WORK-001):
With `_teardown_pending` set, Core MUST NOT schedule new boundary work: no new legacy preload RPC, legacy switch RPC, or segment planning.

Implementation:

1. In `tick()`, after grace timeout check (P12-CORE-004):
   - Check: `if self._teardown_pending`
   - If true: log debug "skipping boundary work: teardown pending", return early
   - This prevents any new boundary evaluation or scheduling

2. In `start()` (if it can be called on running channel):
   - Check: `if self._teardown_pending`
   - If true: log warning "cannot start: teardown pending", return early

3. In any method that explicitly schedules legacy preload RPC:
   - Check `_teardown_pending` before scheduling
   - If true: skip scheduling, log debug

4. In any method that explicitly schedules legacy switch RPC:
   - Check `_teardown_pending` before scheduling
   - If true: skip scheduling, log debug

Constraints:
- MUST NOT cancel in-flight timers (only prevent new ones)
- MUST NOT prevent existing switch deadline callbacks from firing
- The purpose is to avoid EXTENDING the transient state, not to abort current work

Edge Cases:
- Switch timer fires while teardown pending: let it execute (it will reach LIVE or FAILED_TERMINAL)
- legacy preload RPC callback fires while teardown pending: let it execute
- Only NEWLY INITIATED work is blocked

Done Criteria:
No new boundary work scheduled when `_teardown_pending` is True; existing scheduled work completes normally; transient state eventually resolves to stable.

---

## Completion

**Completed:** 2025-02-02

**Changes (pkg/core/src/retrovue/runtime/channel_manager.py):**
- In `tick()`, after grace timeout check (P12-CORE-004): if `_teardown_pending`, log debug "Skipping boundary work (teardown pending)", return early. No new legacy preload RPC/legacy switch RPC scheduling.
- In `_ensure_producer_running()` at start: if `_teardown_pending`, log warning "Cannot start channel (teardown pending)", return. Prevents new producer start while teardown deferred.
- In-flight timers/callbacks are not cancelled; only new work is blocked.
