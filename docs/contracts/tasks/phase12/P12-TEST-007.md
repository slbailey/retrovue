Task ID: P12-TEST-007
Rule ID: INV-TERMINAL-SCHEDULER-HALT-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-008

Instructions:
- Add contract tests for scheduler halt in FAILED_TERMINAL
- Verify tick() returns early without evaluating boundary logic
- Verify no legacy preload RPC or legacy switch RPC scheduled
- Verify health/metrics/diagnostics still work

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TERMINAL-SCHEDULER-HALT-001):
Once `_boundary_state == FAILED_TERMINAL`, Core MUST NOT generate new scheduling intent.

Test Cases:

1. Test tick skips boundary work in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Call `tick()`
   - Expected: tick() returns early; no state changes; no timers scheduled; no RPCs

2. Test no legacy preload RPC in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Attempt to trigger legacy preload RPC scheduling
   - Expected: legacy preload RPC NOT scheduled; log indicates skip

3. Test no legacy switch RPC in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Attempt to trigger legacy switch RPC scheduling
   - Expected: legacy switch RPC NOT scheduled; log indicates skip

4. Test health check allowed in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Call health check method
   - Expected: Health check executes normally; returns appropriate status

5. Test is_live returns False in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Query `is_live` property
   - Expected: Returns False (session is dead, not live)

6. Test multiple ticks in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Call `tick()` 10 times
   - Expected: All ticks return early; no work done; state unchanged

7. Test FAILED_TERMINAL check independent of teardown_pending:
   - Initial state: `_boundary_state = FAILED_TERMINAL`, `_teardown_pending = False`
   - Action: Call `tick()`
   - Expected: tick() returns early (FAILED_TERMINAL check, not teardown check)

Done Criteria:
No scheduling intent in FAILED_TERMINAL; tick() effectively no-op; health/metrics/diagnostics allowed; independent of teardown_pending.

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** `test_p12_tick_skips_boundary_work_in_failed_terminal`, `test_p12_no_load_preview_in_failed_terminal`, `test_p12_no_switch_to_live_in_failed_terminal`, `test_p12_health_check_allowed_in_failed_terminal`, `test_p12_is_live_false_in_failed_terminal_p12_test_007`, `test_p12_multiple_ticks_in_failed_terminal`, `test_p12_failed_terminal_check_independent_of_teardown_pending`.
