Task ID: P12-TEST-001
Rule ID: INV-TEARDOWN-STABLE-STATE-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-003

Instructions:
- Add contract tests for teardown blocking in transient states
- Verify teardown is deferred in all transient states
- Verify teardown proceeds in all stable states

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-STABLE-STATE-001):
Teardown due to viewer inactivity MUST be deferred until `_boundary_state` is stable.

Test Cases:

1. Test teardown blocked in SWITCH_ISSUED:
   - Initial state: `_boundary_state = SWITCH_ISSUED`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns False, `_teardown_pending = True`, `_teardown_deadline` set

2. Test teardown blocked in SWITCH_SCHEDULED:
   - Initial state: `_boundary_state = SWITCH_SCHEDULED`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns False, `_teardown_pending = True`

3. Test teardown blocked in PRELOAD_ISSUED:
   - Initial state: `_boundary_state = PRELOAD_ISSUED`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns False, `_teardown_pending = True`

4. Test teardown blocked in PLANNED:
   - Initial state: `_boundary_state = PLANNED`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns False, `_teardown_pending = True`

5. Test teardown allowed in LIVE:
   - Initial state: `_boundary_state = LIVE`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns True, `_teardown_pending` unchanged (False)

6. Test teardown allowed in NONE:
   - Initial state: `_boundary_state = NONE`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns True

7. Test teardown allowed in FAILED_TERMINAL:
   - Initial state: `_boundary_state = FAILED_TERMINAL`
   - Action: Call `_request_teardown("viewer_inactive")`
   - Expected: Returns True

Done Criteria:
All transient states block teardown; all stable states allow teardown; `_teardown_pending` and `_teardown_deadline` set correctly on deferral.

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** Parametrized `test_p12_teardown_blocked_in_transient_state` (SWITCH_ISSUED, SWITCH_SCHEDULED, PRELOAD_ISSUED, PLANNED); `test_p12_teardown_allowed_in_live`, `test_p12_teardown_allowed_in_none`, `test_p12_teardown_allowed_in_failed_terminal`. All assert return value and pending/deadline as specified.
