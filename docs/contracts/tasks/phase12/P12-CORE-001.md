Task ID: P12-CORE-001
Rule ID: INV-TEARDOWN-STABLE-STATE-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: —

Instructions:
- Add `_teardown_pending` flag (bool)
- Add `_teardown_deadline` field (datetime | None)
- Add `_teardown_reason` field (str | None)
- Define `_STABLE_STATES` and `_TRANSIENT_STATES` constants
- Initialize fields in `__init__`
- Clear fields in `stop_channel`

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-STABLE-STATE-001):
Teardown due to viewer inactivity MUST be deferred until `_boundary_state` is stable. Never execute teardown in a transient state.

Implementation:

1. Add module-level constants:
   - `_STABLE_STATES: set[BoundaryState] = {BoundaryState.NONE, BoundaryState.LIVE, BoundaryState.FAILED_TERMINAL}`
   - `_TRANSIENT_STATES: set[BoundaryState] = {BoundaryState.PLANNED, BoundaryState.PRELOAD_ISSUED, BoundaryState.SWITCH_SCHEDULED, BoundaryState.SWITCH_ISSUED}`
   - `_TEARDOWN_GRACE_TIMEOUT: timedelta = timedelta(seconds=10)`

2. Add instance fields in `__init__`:
   - `self._teardown_pending: bool = False`
   - `self._teardown_deadline: datetime | None = None`
   - `self._teardown_reason: str | None = None`

3. Clear fields in `stop_channel`:
   - Reset all three teardown fields to their initial values

Rationale:
These fields track deferred teardown state. Without them, there is no way to remember that teardown was requested but could not be executed due to transient state.

Done Criteria:
Fields exist and are properly initialized; `_STABLE_STATES` and `_TRANSIENT_STATES` constants defined; no behavioral change yet (this task is pure state scaffolding).

---

## Completion

**Completed:** 2025-02-02

**Changes:**
- **pkg/core/src/retrovue/runtime/channel_manager.py**
  - Added module-level constants: `_STABLE_STATES`, `_TRANSIENT_STATES`, `_TEARDOWN_GRACE_TIMEOUT` (10s).
  - In `__init__`: added `_teardown_pending: bool = False`, `_teardown_deadline: datetime | None = None` (kept existing `_teardown_reason`).
  - In `stop_channel()`: clear `_teardown_pending`, `_teardown_deadline`, `_teardown_reason` on explicit stop.

**Tests:**
- **pkg/core/tests/runtime/test_p12_teardown_scaffolding.py** — 4 tests: constants defined and disjoint, grace timeout 10s, fields initialized, `stop_channel()` clears the three teardown fields.
- All 71 existing runtime tests pass; 4 new P12 scaffolding tests pass.
