Task ID: P12-TEST-005
Rule ID: INV-VIEWER-COUNT-ADVISORY-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager, ProgramDirector
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-006

Instructions:
- Add contract tests for viewer disconnect handling
- Verify disconnect during transient state defers teardown
- Verify disconnect during stable state proceeds immediately
- Test end-to-end through ProgramDirector

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-VIEWER-COUNT-ADVISORY-001):
Viewer count is advisory, not authoritative, for teardown during transient states. Zero viewers MUST trigger (not force) teardown request.

Test Cases:

1. Test viewer disconnect defers during SWITCH_ISSUED:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, viewer connected
   - Action: Viewer disconnects (count = 0)
   - Expected: `_request_teardown()` called; returns False; channel NOT destroyed; `_teardown_pending = True`

2. Test viewer disconnect proceeds during LIVE:
   - Initial state: `_boundary_state = LIVE`, viewer connected
   - Action: Viewer disconnects (count = 0)
   - Expected: `_request_teardown()` called; returns True; channel destruction proceeds

3. Test viewer disconnect defers during SWITCH_SCHEDULED:
   - Initial state: `_boundary_state = SWITCH_SCHEDULED`, viewer connected
   - Action: Viewer disconnects
   - Expected: Teardown deferred; channel remains active

4. Test deferred teardown completes after LIVE:
   - Initial state: Viewer disconnected during SWITCH_ISSUED, teardown pending
   - Action: Transition to LIVE
   - Expected: Deferred teardown executes; channel destroyed

5. Test rapid disconnect/reconnect (idempotent):
   - Initial state: `_boundary_state = SWITCH_ISSUED`
   - Action: Viewer disconnects, reconnects, disconnects again
   - Expected: Only one teardown request pending; deadline not reset

Done Criteria:
Viewer disconnect routes through `_request_teardown()`; transient states defer; stable states proceed; integration with ProgramDirector works.

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** `test_p12_viewer_disconnect_defers_during_switch_issued`, `test_p12_viewer_disconnect_proceeds_during_live`, `test_p12_viewer_disconnect_defers_during_switch_scheduled`, `test_p12_deferred_teardown_completes_after_live`, `test_p12_rapid_disconnect_reconnect_idempotent`. Simulated disconnect via _request_teardown(); deferred completion via _transition_boundary_state(LIVE); idempotent multiple _request_teardown() calls.
