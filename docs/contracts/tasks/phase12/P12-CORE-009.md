Task ID: P12-CORE-009
Rule ID: INV-TERMINAL-TIMER-CLEARED-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P12-CORE-008

Instructions:
- Cancel all transient timers when transitioning to FAILED_TERMINAL
- Add timer cancellation logic in `_transition_boundary_state()`
- Prevents ghost timer execution after terminal failure

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TERMINAL-TIMER-CLEARED-001):
Upon transition to `FAILED_TERMINAL`, all pending transient operation timers MUST be cancelled immediately. This includes:
- Switch issuance timers (`_switch_handle`)
- LoadPreview scheduling timers
- Any deadline-scheduled boundary callbacks

Implementation:

1. In `_transition_boundary_state()`, when `new_state == FAILED_TERMINAL`:
   - Cancel `_switch_handle` if not None, set to None
   - Cancel any other boundary-related timers
   - Log: "INV-TERMINAL-TIMER-CLEARED-001: Cancelled transient timers on terminal entry"

2. Timer cancellation should occur:
   - On legal transition to FAILED_TERMINAL (e.g., from SWITCH_ISSUED)
   - On illegal transition forcing FAILED_TERMINAL
   - On grace timeout forcing FAILED_TERMINAL

3. Pseudo-logic in `_transition_boundary_state()`:
   ```
   if new_state == BoundaryState.FAILED_TERMINAL:
       if self._switch_handle is not None:
           self._switch_handle.cancel()
           self._switch_handle = None
           self._logger.info("INV-TERMINAL-TIMER-CLEARED-001: Switch timer cancelled")
       # Cancel any other transient timers here
   ```

Constraints:
- Timer cancellation MUST happen before deferred teardown check
- Cancellation is idempotent (safe to call even if timer already fired)
- Must handle both legal and illegal transitions to FAILED_TERMINAL

Rationale:
Ghost timers firing after terminal failure generate spurious errors:
- `_on_switch_issue_deadline()` fires but boundary is FAILED_TERMINAL
- Guard catches it (INV-SWITCH-ISSUANCE-ONESHOT-001), but attempt was made
- Clearing timers prevents the attempt entirely

Done Criteria:
All transient timers cancelled on FAILED_TERMINAL entry; no ghost timer callbacks fire after terminal failure; logging confirms cancellation.

---

## Completion

**Completed:** 2025-02-02

**Changes (pkg/core/src/retrovue/runtime/channel_manager.py):**
- Added `_cancel_transient_timers()`: cancels `_switch_issue_timer` (with lock) and `_switch_handle`; logs "INV-TERMINAL-TIMER-CLEARED-001: Cancelled transient timers on terminal entry" when any cancelled. Idempotent.
- In `_transition_boundary_state()`: on illegal transition to FAILED_TERMINAL, call `_cancel_transient_timers()` before deferred teardown check. On legal path when `new_state == FAILED_TERMINAL`, call `_cancel_transient_timers()` after setting state, before NONE/deferred-teardown logic.
