Task ID: P12-TEST-002
Rule ID: INV-TEARDOWN-STABLE-STATE-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-003

Instructions:
- Add contract tests for deferred teardown execution on stable state entry
- Verify deferred teardown executes when entering LIVE
- Verify deferred teardown executes when entering FAILED_TERMINAL
- Verify deferred teardown executes when entering NONE

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-STABLE-STATE-001):
Teardown due to viewer inactivity MUST be deferred until `_boundary_state` is stable.

Test Cases:

1. Test deferred teardown executes on LIVE entry:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`
   - Action: Call `_transition_boundary_state(LIVE)`
   - Expected: Transition succeeds; deferred teardown signal fired; `_teardown_pending` cleared

2. Test deferred teardown executes on FAILED_TERMINAL entry:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`
   - Action: Call `_transition_boundary_state(FAILED_TERMINAL)`
   - Expected: Transition succeeds; deferred teardown signal fired; `_teardown_pending` cleared

3. Test deferred teardown executes on NONE entry (from LIVE):
   - Initial state: `_boundary_state = LIVE`, `_teardown_pending = True`
   - Action: Call `_transition_boundary_state(NONE)`
   - Expected: Transition succeeds; deferred teardown signal fired

4. Test no spurious teardown when not pending:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = False`
   - Action: Call `_transition_boundary_state(LIVE)`
   - Expected: Transition succeeds; NO teardown signal fired

5. Test teardown pending cleared after execution:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`
   - Action: Call `_transition_boundary_state(LIVE)`
   - Expected: After execution, `_teardown_pending = False`, `_teardown_deadline = None`

Done Criteria:
Deferred teardown executes exactly once on stable state entry; does not execute when not pending; pending state cleared after execution.

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** `test_p12_deferred_teardown_executes_on_live_entry`, `test_p12_deferred_teardown_executes_on_failed_terminal_entry`, `test_p12_deferred_teardown_executes_on_none_entry`, `test_p12_no_spurious_teardown_when_not_pending`, `test_p12_teardown_pending_cleared_after_execution`. Assert transition succeeds, deferred_teardown_triggered() and pending/deadline cleared.
