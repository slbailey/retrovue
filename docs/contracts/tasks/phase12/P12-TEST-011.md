Task ID: P12-TEST-011
Rule ID: INV-STARTUP-CONVERGENCE-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_startup.py
Owner: Core
Blocked By: P12-CORE-013

Instructions:
- Add contract tests for convergence timeout enforcement
- Verify FAILED_TERMINAL when convergence deadline expires
- Verify timeout is safety net, not normal operation
- Test interaction with deferred teardown

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-STARTUP-CONVERGENCE-001):
The session MUST converge within MAX_STARTUP_CONVERGENCE_WINDOW (120 seconds). Failure to converge transitions the session to FAILED_TERMINAL.

Test Cases:

1. Test convergence timeout triggers FAILED_TERMINAL:
   - Setup: Session created; no boundary executes; advance time past deadline
   - Action: Call tick() or boundary evaluation after deadline
   - Expected: `_boundary_state = FAILED_TERMINAL`; `_pending_fatal` set

2. Test convergence timeout logged as FATAL:
   - Setup: Session times out without converging
   - Action: Check logs after timeout
   - Expected: Log contains "INV-STARTUP-CONVERGENCE-001 FATAL: Convergence timeout expired"

3. Test no timeout after convergence:
   - Setup: Session converged at T+10s
   - Action: Advance time past original deadline (T+120s)
   - Expected: No timeout; session continues normally; `_converged = True`

4. Test timeout clears convergence deadline:
   - Setup: Session times out
   - Action: Check state after FAILED_TERMINAL
   - Expected: Session in FAILED_TERMINAL; ready for teardown

5. Test timeout triggers deferred teardown:
   - Setup: Session with `_teardown_pending = True`; times out without converging
   - Action: Timeout expires
   - Expected: FAILED_TERMINAL (stable state); deferred teardown executes

6. Test timeout with skipped boundaries:
   - Setup: Session skips 10 boundaries; none feasible; time passes
   - Action: Deadline expires
   - Expected: FAILED_TERMINAL; logged as convergence timeout

7. Test convergence before timeout:
   - Setup: Session created at T; boundary executes at T+30s
   - Action: Check state at T+30s and T+120s
   - Expected: Converged at T+30s; no timeout at T+120s

8. Test timeout value is configurable (if applicable):
   - Setup: Custom MAX_STARTUP_CONVERGENCE_WINDOW
   - Action: Session with custom timeout
   - Expected: Timeout respects configured value

Done Criteria:
Convergence timeout forces FAILED_TERMINAL; logged as FATAL; no timeout after convergence; interacts correctly with deferred teardown.

---

## Completion

- **Date:** 2026-02-02
- **Implementation:** `pkg/core/tests/runtime/test_channel_manager_startup.py`
  - test_p12_convergence_timeout_forces_failed_terminal: deadline in past -> FAILED_TERMINAL, _pending_fatal set.
  - test_p12_convergence_timeout_logged_fatal: INV-STARTUP-CONVERGENCE-001 FATAL and "timeout expired" in logs.
  - test_p12_no_timeout_after_converged: _converged True -> no timeout; state not FAILED_TERMINAL from timeout.
  - test_p12_convergence_before_timeout: converged session, boundary in future after advance(130); tick() leaves PLANNED.
- **Tests:** 17 startup tests; 148 runtime tests total.
