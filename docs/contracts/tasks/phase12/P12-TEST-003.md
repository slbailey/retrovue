Task ID: P12-TEST-003
Rule ID: INV-TEARDOWN-GRACE-TIMEOUT-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-004

Instructions:
- Add contract tests for grace timeout enforcement
- Verify timeout forces FAILED_TERMINAL
- Verify timeout triggers deferred teardown
- Use ControllableMasterClock for deterministic testing

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-GRACE-TIMEOUT-001):
Deferred teardown MUST NOT wait indefinitely. Grace timeout (default: 10s) MUST be enforced. If elapsed while still transient, boundary MUST be forced to FAILED_TERMINAL.

Test Cases:

1. Test grace timeout forces FAILED_TERMINAL:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`, deadline in past
   - Action: Call `tick()`
   - Expected: `_boundary_state` transitions to `FAILED_TERMINAL`; `_pending_fatal` contains timeout info

2. Test grace timeout triggers deferred teardown:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`, deadline in past
   - Action: Call `tick()`
   - Expected: Deferred teardown signal fired after FAILED_TERMINAL transition

3. Test no timeout when deadline not reached:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`, deadline in future
   - Action: Call `tick()`
   - Expected: State unchanged; no FAILED_TERMINAL; tick continues normally (but skips work per P12-CORE-005)

4. Test no timeout when not pending:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = False`
   - Action: Call `tick()` with clock past hypothetical deadline
   - Expected: No timeout check fires; normal tick behavior

5. Test timeout with controllable clock:
   - Initial state: `_teardown_pending = True`, deadline = now + 10s
   - Action: Advance clock by 11s, call `tick()`
   - Expected: Timeout fires; FAILED_TERMINAL

Done Criteria:
Grace timeout reliably triggers FAILED_TERMINAL when expired; does not trigger when not expired or not pending; uses testable clock.

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** `test_p12_grace_timeout_forces_failed_terminal`, `test_p12_grace_timeout_triggers_deferred_teardown`, `test_p12_no_timeout_when_deadline_not_reached`, `test_p12_no_timeout_when_not_pending`, `test_p12_timeout_with_controllable_clock`. Uses ControllableMasterClock; deadline_in_past helper and advance(11) for timeout.
