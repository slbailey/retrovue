Task ID: P12-CORE-011
Rule ID: INV-STARTUP-CONVERGENCE-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P12-CORE-010

Instructions:
- Add `_converged` flag to ChannelManager (initially False)
- Add `_convergence_deadline` field for convergence timeout
- Set `_converged = True` after first successful boundary transition
- Add `MAX_STARTUP_CONVERGENCE_WINDOW` constant (default: 120 seconds)

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-STARTUP-CONVERGENCE-001):
A session is in "startup convergence" from creation until the first successful boundary transition. During convergence:
1. Infeasible boundaries are skipped, not fatal
2. Current segment playback continues across skipped boundaries
3. The session MUST converge within MAX_STARTUP_CONVERGENCE_WINDOW
4. Failure to converge transitions the session to FAILED_TERMINAL

Implementation:

1. Add state fields to ChannelManager `__init__()`:
   ```python
   self._converged: bool = False
   self._convergence_deadline: datetime | None = None
   ```

2. Add constant:
   ```python
   MAX_STARTUP_CONVERGENCE_WINDOW = timedelta(seconds=120)
   ```

3. In session creation (after P12-CORE-010 ungate):
   ```python
   self._converged = False
   self._convergence_deadline = datetime.now(timezone.utc) + MAX_STARTUP_CONVERGENCE_WINDOW
   ```

4. On successful boundary transition (entering LIVE from SWITCH_ISSUED):
   ```python
   if not self._converged:
       self._converged = True
       self._convergence_deadline = None
       self._logger.info("INV-STARTUP-CONVERGENCE-001: Session converged after first boundary")
   ```

5. Add property for inspection:
   ```python
   @property
   def converged(self) -> bool:
       return self._converged
   ```

6. Per-session scope:
   - Startup convergence applies only to a newly created session
   - Ends permanently after first committed boundary executes successfully
   - A session cannot re-enter convergence mid-lifecycle

Constraints:
- `_converged` is one-way: once True, never False again
- `MAX_STARTUP_CONVERGENCE_WINDOW` is an upper bound, not a target duration
- Convergence timeout enforcement is handled in P12-CORE-013

Rationale:
Startup is not a boundary transition. Joining a segment already in progress is a seek operation. The system must "play something now" over startup perfection. But convergence cannot be indefiniteâ€”the flag tracks when the session achieves steady-state operation.

Done Criteria:
`_converged` flag tracks convergence state; set to True on first successful boundary; `_convergence_deadline` set at session creation; property exposes convergence state.

---

## Completion

- **Date:** 2026-02-02
- **Implementation:** `channel_manager.py`
  - Added module constant `MAX_STARTUP_CONVERGENCE_WINDOW = timedelta(seconds=120)`.
  - In `__init__`: `_converged = False`, `_convergence_deadline = None`.
  - In session creation (end of producer launch in `_ensure_producer_running`): `_converged = False`, `_convergence_deadline = clock.now_utc() + MAX_STARTUP_CONVERGENCE_WINDOW`.
  - In `_transition_boundary_state` on successful transition: when `new_state == BoundaryState.LIVE` and not `_converged`, set `_converged = True`, `_convergence_deadline = None`, log `INV-STARTUP-CONVERGENCE-001: Session converged after first boundary`.
  - Added `converged` property; cleared `_converged`/`_convergence_deadline` in `stop_channel()`.
- **Tests:** Runtime suite 131 passed. Convergence timeout (P12-CORE-013) and boundary-skip (P12-CORE-012) tests pending.
