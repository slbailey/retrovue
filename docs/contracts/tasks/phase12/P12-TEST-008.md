Task ID: P12-TEST-008
Rule ID: INV-TERMINAL-TIMER-CLEARED-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-009

Instructions:
- Add contract tests for timer cancellation on FAILED_TERMINAL entry
- Verify switch timer cancelled
- Verify no ghost timer callbacks fire
- Test both legal and illegal transitions to FAILED_TERMINAL

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TERMINAL-TIMER-CLEARED-001):
Upon transition to `FAILED_TERMINAL`, all pending transient operation timers MUST be cancelled immediately.

Test Cases:

1. Test switch timer cancelled on FAILED_TERMINAL:
   - Initial state: `_boundary_state = SWITCH_SCHEDULED`, `_switch_handle` set
   - Action: Call `_transition_boundary_state(FAILED_TERMINAL)`
   - Expected: `_switch_handle` is None after transition; timer was cancelled

2. Test timer cancelled on illegal transition:
   - Initial state: `_boundary_state = SWITCH_SCHEDULED`, `_switch_handle` set
   - Action: Attempt illegal transition that forces FAILED_TERMINAL
   - Expected: `_switch_handle` is None after forced terminal; timer cancelled

3. Test timer cancelled on grace timeout:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_switch_handle` set, teardown pending, deadline expired
   - Action: Call `tick()` (triggers grace timeout â†’ FAILED_TERMINAL)
   - Expected: `_switch_handle` is None after terminal; timer cancelled

4. Test no ghost callback after terminal:
   - Initial state: Schedule switch timer, then transition to FAILED_TERMINAL
   - Action: Advance clock past timer deadline, run event loop
   - Expected: Timer callback does NOT fire (was cancelled); no log errors

5. Test cancellation idempotent:
   - Initial state: `_boundary_state = FAILED_TERMINAL`, `_switch_handle = None`
   - Action: Call `_transition_boundary_state(FAILED_TERMINAL)` again (illegal, but tests idempotence)
   - Expected: No crash; state remains FAILED_TERMINAL

6. Test multiple timers cancelled:
   - Initial state: Multiple boundary timers scheduled (if applicable)
   - Action: Transition to FAILED_TERMINAL
   - Expected: All timers cancelled; none fire

Done Criteria:
All transient timers cancelled on FAILED_TERMINAL entry; no ghost callbacks; cancellation logged; idempotent.

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** `test_p12_switch_timer_cancelled_on_failed_terminal`, `test_p12_timer_cancelled_on_illegal_transition`, `test_p12_timer_cancelled_on_grace_timeout`, `test_p12_cancel_transient_timers_idempotent`.
