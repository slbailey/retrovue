Task ID: P12-TEST-004
Rule ID: INV-TEARDOWN-NO-NEW-WORK-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/runtime/test_channel_manager_teardown.py
Owner: Core
Blocked By: P12-CORE-005

Instructions:
- Add contract tests for work blocking when teardown pending
- Verify tick() skips boundary evaluation
- Verify no new legacy preload RPC scheduled
- Verify no new legacy switch RPC scheduled
- Verify existing scheduled work still fires

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-NO-NEW-WORK-001):
With `_teardown_pending` set, Core MUST NOT schedule new boundary work: no new legacy preload RPC, legacy switch RPC, or segment planning.

Test Cases:

1. Test tick skips boundary work when pending:
   - Initial state: `_boundary_state = SWITCH_ISSUED`, `_teardown_pending = True`, grace timeout NOT expired
   - Action: Call `tick()`
   - Expected: tick() returns early; no state changes; no new timers scheduled

2. Test no new legacy preload RPC when pending:
   - Initial state: `_teardown_pending = True`
   - Action: Attempt to schedule legacy preload RPC (via whatever mechanism triggers it)
   - Expected: legacy preload RPC NOT scheduled; log indicates skip

3. Test no new legacy switch RPC when pending:
   - Initial state: `_teardown_pending = True`
   - Action: Attempt to schedule legacy switch RPC
   - Expected: legacy switch RPC NOT scheduled; log indicates skip

4. Test existing switch timer still fires when pending:
   - Initial state: Switch timer already scheduled, then `_teardown_pending = True`
   - Action: Timer fires
   - Expected: Switch callback executes normally (reaches LIVE or FAILED_TERMINAL)

5. Test multiple ticks while pending:
   - Initial state: `_teardown_pending = True`, grace timeout far in future
   - Action: Call `tick()` 10 times
   - Expected: All ticks return early; no work done; state unchanged

Done Criteria:
No new boundary work when pending; existing in-flight work completes; tick is effectively a no-op (except timeout check).

---

## Completion

**Completed:** 2025-02-02

**File:** pkg/core/tests/runtime/test_channel_manager_teardown.py

**Tests:** `test_p12_tick_skips_boundary_work_when_pending`, `test_p12_no_new_load_preview_when_pending`, `test_p12_no_new_switch_to_live_when_pending`, `test_p12_ensure_producer_running_blocked_when_pending`, `test_p12_multiple_ticks_while_pending`. Tick returns early; no new legacy preload RPC/legacy switch RPC; _ensure_producer_running returns early; 10 ticks no-op.
