Task ID: P12-CORE-004
Rule ID: INV-TEARDOWN-GRACE-TIMEOUT-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P12-CORE-002

Instructions:
- Add grace timeout check at start of `tick()`
- If timeout expired while still transient, force `FAILED_TERMINAL`
- Timeout check must occur before any other tick logic

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-TEARDOWN-GRACE-TIMEOUT-001):
Deferred teardown MUST NOT wait indefinitely. Grace timeout (default: 10s) MUST be enforced. If elapsed while still transient, boundary MUST be forced to `FAILED_TERMINAL`.

Implementation:

1. At start of `tick()`, before any other logic:
   - Check: `if self._teardown_pending and self._teardown_deadline is not None`
   - If `self.clock.now_utc() >= self._teardown_deadline`:
     - Log warning: `"INV-TEARDOWN-GRACE-TIMEOUT-001: Grace timeout expired in state %s after %s"`
     - Set `_pending_fatal = SchedulingError(f"Teardown grace timeout in state {self._boundary_state.name}")`
     - Call `_transition_boundary_state(BoundaryState.FAILED_TERMINAL)`
     - Return early (transition will trigger deferred teardown via P12-CORE-003)

2. Logging must include:
   - Current boundary state
   - How long the deferral lasted
   - Original teardown reason

Constraints:
- Timeout check MUST be first logic in `tick()`
- MUST use `self.clock.now_utc()` (testable clock)
- MUST NOT use wall clock directly
- Transitioning to `FAILED_TERMINAL` triggers deferred teardown (per P12-CORE-003)

Edge Cases:
- Already in `FAILED_TERMINAL` when timeout fires: redundant but harmless
- Timeout fires exactly as state becomes stable: race resolved by checking after transition

Done Criteria:
Grace timeout reliably forces `FAILED_TERMINAL` when transition stalls; timeout is bounded and predictable; logging provides diagnostics.

---

## Completion

**Completed:** 2025-02-02

**Changes (pkg/core/src/retrovue/runtime/channel_manager.py):**
- At **start** of `tick()` (first logic): if `_teardown_pending and _teardown_deadline` and `clock.now_utc() >= _teardown_deadline`, log warning with state, duration, reason; set `_pending_fatal = SchedulingError(...)`; call `_transition_boundary_state(BoundaryState.FAILED_TERMINAL)`; return.
- Duration computed as `now - (deadline - _TEARDOWN_GRACE_TIMEOUT)` for diagnostics.
- Transition to FAILED_TERMINAL triggers deferred teardown via P12-CORE-003.
