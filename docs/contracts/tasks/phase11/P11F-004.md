Task ID: P11F-004
Rule ID: INV-SWITCH-ISSUANCE-ONESHOT-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P11F-002

Instructions:
- Add guard to prevent duplicate switch issuance
- Suppress if state >= SWITCH_ISSUED
- FATAL if state == FAILED_TERMINAL

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-SWITCH-ISSUANCE-ONESHOT-001):
SwitchToLive MUST be issued exactly once per boundary. Duplicate issuance attempts are suppressed. Duplicate into FAILED_TERMINAL is treated as a control-flow bug (FATAL).

Implementation:

1. Add guard function:
   ```python
   def _guard_switch_issuance(self, boundary_time: datetime) -> bool:
       """INV-SWITCH-ISSUANCE-ONESHOT-001: Returns True if issuance is allowed."""
       if self._boundary_state in (
           BoundaryState.SWITCH_ISSUED,
           BoundaryState.LIVE,
       ):
           # Benign duplicate — suppress, log warning
           self._logger.warning(
               "INV-SWITCH-ISSUANCE-ONESHOT-001: Suppressed duplicate issuance for %s (state=%s)",
               boundary_time.isoformat(), self._boundary_state.name
           )
           return False

       if self._boundary_state == BoundaryState.FAILED_TERMINAL:
           # Duplicate into terminal state — this is a control flow bug
           self._logger.error(
               "INV-SWITCH-ISSUANCE-ONESHOT-001 FATAL: Attempted issuance for %s but boundary is FAILED_TERMINAL",
               boundary_time.isoformat()
           )
           self._pending_fatal = SchedulingError(
               f"Attempted switch issuance for failed boundary {boundary_time}"
           )
           return False

       return True
   ```

2. Call guard at start of _on_switch_issue_deadline():
   ```python
   async def _on_switch_issue_deadline(self, boundary_time: datetime) -> None:
       # Guard: one-shot only
       if not self._guard_switch_issuance(boundary_time):
           return
       # ... proceed with issuance ...
   ```

3. Guard tick() to prevent re-evaluation:
   ```python
   async def tick(self) -> None:
       # INV-SWITCH-ISSUANCE-ONESHOT-001: Never re-issue for same boundary
       if self._boundary_state in (
           BoundaryState.SWITCH_ISSUED,
           BoundaryState.LIVE,
           BoundaryState.FAILED_TERMINAL,
       ):
           # Boundary already processed; do not re-evaluate
           return
       # ... rest of tick logic ...
   ```

Constraints:
- Duplicate into SWITCH_ISSUED/LIVE: suppress + warning
- Duplicate into FAILED_TERMINAL: FATAL + pending_fatal
- Tick must not re-evaluate processed boundaries

Done Criteria:
Duplicate issuance attempts are suppressed; duplicate into terminal is fatal; tick loop cannot re-trigger issuance.

---

## Completion Status

| Field | Value |
|-------|-------|
| **Status** | COMPLETE |
| **Completed** | 2026-02-02 |
| **Implementation** | _guard_switch_issuance(boundary_time) added; returns False for SWITCH_ISSUED/LIVE (suppress + warning) and FAILED_TERMINAL (FATAL + _pending_fatal). Called at start of _on_switch_issue_deadline. tick() returns early when _boundary_state in (SWITCH_ISSUED, LIVE, FAILED_TERMINAL). |
| **Tests** | 32 runtime tests passed; log shows "Suppressed duplicate issuance" (state=SWITCH_ISSUED). |
