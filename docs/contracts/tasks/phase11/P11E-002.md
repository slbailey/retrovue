Task ID: P11E-002
Rule ID: INV-CONTROL-NO-POLL-001
Subsystem: ChannelManager/Scheduler
Task Type: FIX
File(s) to Modify: pkg/core/retrovue/runtime/channel_manager.py, pkg/core/retrovue/schedule/schedule_manager.py
Owner: Core
Blocked By: P11E-001

Instructions:
- Issue LoadPreview at boundary_time - MIN_PREFEED_LEAD_TIME_MS
- Adjust scheduling loop to trigger at correct time

---

Rule Definition:
Core MUST issue LoadPreview with sufficient lead time that AIR can achieve readiness before the declared boundary time.

Implementation:

1. Calculate LoadPreview trigger time:
   ```python
   def _get_load_preview_trigger_time(self, boundary: GridBoundary) -> datetime:
       """Calculate when to issue LoadPreview for a given boundary."""
       # Issue LoadPreview at (boundary - MIN_PREFEED_LEAD_TIME - buffer)
       # Buffer accounts for scheduling jitter
       SCHEDULING_BUFFER = timedelta(seconds=2)

       trigger_time = boundary.time - MIN_PREFEED_LEAD_TIME - SCHEDULING_BUFFER
       return trigger_time
   ```

2. Update scheduling loop:
   ```python
   async def _scheduling_tick(self):
       """Called every SCHEDULE_TICK_INTERVAL."""
       now = datetime.now(timezone.utc)

       for channel_id in self.active_channels:
           # Get upcoming boundaries for this channel
           boundaries = self.schedule_manager.get_upcoming_boundaries(
               channel_id,
               window=timedelta(seconds=30)
           )

           for boundary in boundaries:
               trigger_time = self._get_load_preview_trigger_time(boundary)

               # Time to issue LoadPreview?
               if now >= trigger_time and not self._is_preview_loading(channel_id, boundary):
                   logger.info(
                       f"INV-CONTROL-NO-POLL-001: Issuing LoadPreview for boundary at {boundary.time} "
                       f"(lead time: {(boundary.time - now).total_seconds():.1f}s)"
                   )
                   await self._issue_load_preview(channel_id, boundary)
   ```

3. Issue LoadPreview with timing context:
   ```python
   async def _issue_load_preview(self, channel_id: int, boundary: GridBoundary):
       """Issue LoadPreview for upcoming boundary."""
       now = datetime.now(timezone.utc)
       lead_time = boundary.time - now

       logger.info(
           f"LoadPreview issued for channel {channel_id}, "
           f"boundary={boundary.time.isoformat()}, "
           f"lead_time_ms={int(lead_time.total_seconds() * 1000)}"
       )

       request = LoadPreviewRequest(
           channel_id=channel_id,
           plan_handle=boundary.plan_handle,
           target_boundary_time_ms=int(boundary.time.timestamp() * 1000)
       )

       response = await self.air_client.load_preview(request)

       if response.status != LoadStatus.OK:
           logger.error(f"LoadPreview failed: {response.status}")
           raise LoadPreviewError(f"Failed to load preview: {response.status}")

       # Track that we've issued LoadPreview for this boundary
       self._mark_preview_loading(channel_id, boundary)
   ```

4. Timeline visualization:
   ```
   Timeline for boundary at T=0:

   T-32s: Boundary enters 30s lookahead window
   T-7s:  trigger_time (MIN_PREFEED_LEAD_TIME + SCHEDULING_BUFFER)
          → LoadPreview issued
   T-5s:  Minimum point at which SwitchToLive can be issued
   T-2s:  SwitchToLive issued with target_boundary_time_ms=T
   T-0:   Switch executes at boundary
   ```

Constraints:
- LoadPreview MUST be issued ≥MIN_PREFEED_LEAD_TIME before boundary
- Scheduling tick rate must be fast enough (≤1 second recommended)
- Handle case where scheduling starts with boundary already imminent
- Log lead time for each LoadPreview

Done Criteria:
LoadPreview issued at boundary_time - MIN_PREFEED_LEAD_TIME_MS for all upcoming switches.

---
**Done:** `_preload_lead_seconds = 7` (MIN_PREFEED + SCHEDULING_BUFFER) in channel_manager.py. LoadPreview triggered at `segment_end - preload_lead_seconds`. Switch issuance at `segment_end - switch_lead_seconds (6s)` ensures ≥5s lead time at SwitchToLive.
