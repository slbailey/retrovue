Task ID: P11D-006
Rule ID: INV-CONTROL-NO-POLL-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager/Scheduler
Task Type: FIX
**Historical:** This task described behavior removed by [Phase8DecommissionContract](../../../architecture/Phase8DecommissionContract.md). Runtime is BlockPlan only.

File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py, pkg/core/src/retrovue/runtime/schedule_manager.py
Owner: Core
Blocked By: P11D-005, P11D-009, P11D-010, P11D-011

Instructions:
- Ensure legacy preload RPC issued with sufficient lead time before boundary (retired path)
- Scheduling logic must account for MIN_PREFEED_LEAD_TIME_MS

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Since clock doesn't wait for frames, Core MUST declare times it can actually meet. This task ensures Core provides AIR with sufficient lead time to achieve readiness before the declared boundary. If Core can't meet the lead time, that's a scheduling bug — not something to work around with retry loops.

Rule Definition (INV-CONTROL-NO-POLL-001):
Core MUST issue legacy preload RPC with sufficient lead time that AIR can achieve readiness before the declared boundary time.

Implementation:

1. Define lead time constant:
   ```python
   # Minimum time between legacy preload RPC and target boundary
   # Must be sufficient for AIR to buffer content
   MIN_PREFEED_LEAD_TIME = timedelta(seconds=5)
   ```

2. Update schedule lookahead to issue legacy preload RPC earlier:
   ```python
   async def prepare_upcoming_switches(self):
       """Prepare content for upcoming grid boundaries."""
       now = datetime.now(timezone.utc)
       lookahead_window = timedelta(seconds=30)  # Look 30 seconds ahead

       for boundary in self.schedule.get_boundaries_in_window(now, now + lookahead_window):
           time_until_boundary = boundary.time - now

           # Issue legacy preload RPC when we hit the lead time threshold
           if time_until_boundary <= MIN_PREFEED_LEAD_TIME + timedelta(seconds=2):
               # Add small buffer for scheduling jitter
               if not self._is_preview_loading(boundary):
                   await self._issue_load_preview(boundary)
   ```

3. Add validation before legacy switch RPC:
   ```python
   async def _issue_switch_to_live(self, channel_id: int, boundary: GridBoundary):
       """Issue legacy switch RPC for an upcoming boundary."""
       now = datetime.now(timezone.utc)
       time_until_boundary = boundary.time - now

       # Validate we have sufficient lead time
       if time_until_boundary < MIN_PREFEED_LEAD_TIME:
           logger.error(
               f"INV-CONTROL-NO-POLL-001 VIOLATION: Cannot issue legacy switch RPC with only "
               f"{time_until_boundary.total_seconds():.1f}s lead time (min: {MIN_PREFEED_LEAD_TIME.total_seconds():.1f}s). "
               f"Scheduling error detected."
           )
           raise SchedulingError(f"Insufficient lead time for boundary at {boundary.time}")

       # Verify legacy preload RPC was issued
       if not self._is_preview_loaded(channel_id, boundary):
           logger.error(f"INV-CONTROL-NO-POLL-001 VIOLATION: legacy preload RPC not issued before legacy switch RPC")
           raise SchedulingError("legacy preload RPC must precede legacy switch RPC")

       await self.switch_to_live(channel_id, boundary.plan_handle)
   ```

4. Schedule cadence adjustment:
   ```python
   # Scheduling tick rate must be fast enough to hit the lead time window
   SCHEDULE_TICK_INTERVAL = timedelta(seconds=1)  # Check every second

   # Timeline:
   # T-30s: Boundary enters lookahead window
   # T-7s:  legacy preload RPC issued (MIN_PREFEED_LEAD_TIME + buffer)
   # T-5s:  legacy switch RPC issued with target_boundary_time_ms
   # T-0:   Switch executes at boundary
   ```

Constraints:
- legacy preload RPC MUST be issued before legacy switch RPC
- legacy switch RPC MUST have ≥MIN_PREFEED_LEAD_TIME before boundary
- Scheduling tick rate must be fast enough to hit windows
- Log violations for post-hoc debugging

Done Criteria:
All legacy switch RPC calls issued with ≥MIN_PREFEED_LEAD_TIME; legacy preload RPC always precedes legacy switch RPC.

---
**Done:** MIN_PREFEED_LEAD_TIME = timedelta(seconds=5); _preload_lead_seconds = 7, _switch_lead_seconds = 6 (5s + 1s so 1s tick cadence still yields ≥5s at legacy switch RPC); switch_at = segment_end - timedelta(seconds=_switch_lead_seconds). Infeasible at runtime raises SchedulingError (P11D-009). First boundary satisfies INV-STARTUP-BOUNDARY-FEASIBILITY-001 (P11D-010). legacy preload RPC before legacy switch RPC; no runtime feasibility discovery.

**Validation:**
- Happy path: `./scripts/core/run_p11d006_real_assets.sh` and `./scripts/core/run_p11d006_happy_path.sh` — boundaries execute as scheduled, stream delivers bytes and TS sync.
- Error path: short segments / infeasible boundary at runtime triggers SchedulingError (INV-SCHED-PLAN-BEFORE-EXEC-001 FATAL).
