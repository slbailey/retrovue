Task ID: P11F-003
Rule ID: INV-SWITCH-ISSUANCE-TERMINAL-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P11F-002

Instructions:
- Wrap switch issuance in try/except
- On exception, transition to FAILED_TERMINAL
- Do NOT re-register timer
- Do NOT allow tick to retry

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-SWITCH-ISSUANCE-TERMINAL-001):
Exception during SwitchToLive issuance MUST transition boundary to FAILED_TERMINAL state. No retry, no re-arm, no tick-based reissuance.

Implementation:

1. Update _on_switch_issue_deadline():
   ```python
   def _on_switch_issue_deadline_sync(self, boundary_time: datetime) -> None:
       """Called by loop.call_later(). Failure is TERMINAL."""
       asyncio.create_task(self._on_switch_issue_deadline(boundary_time))

   async def _on_switch_issue_deadline(self, boundary_time: datetime) -> None:
       """P11D-011: Called at issue_at. Failure is TERMINAL."""
       try:
           # Guard: one-shot only (P11F-004)
           if not self._guard_switch_issuance(boundary_time):
               return

           self._transition_boundary_state(BoundaryState.SWITCH_ISSUED)
           await self._issue_switch_to_live_impl(boundary_time)
           self._transition_boundary_state(BoundaryState.LIVE)

       except Exception as e:
           # INV-SWITCH-ISSUANCE-TERMINAL-001: Exception is terminal
           self._logger.error(
               "INV-SWITCH-ISSUANCE-TERMINAL-001 FATAL: Switch issuance failed for boundary %s: %s",
               boundary_time.isoformat(), e
           )
           self._transition_boundary_state(BoundaryState.FAILED_TERMINAL)
           self._pending_fatal = SchedulingError(
               f"Switch issuance failed for boundary {boundary_time}: {e}"
           )
           # Do NOT re-arm. Do NOT allow tick to retry.
   ```

2. Remove any catch-and-continue patterns:
   ```python
   # WRONG (current behavior):
   except Exception as e:
       log.error("Switch failed: %s", e)
       # continues; boundary still pending → retried next tick

   # RIGHT (new behavior):
   except Exception as e:
       log.error("INV-SWITCH-ISSUANCE-TERMINAL-001 FATAL: ...")
       self._transition_boundary_state(BoundaryState.FAILED_TERMINAL)
       # boundary is now absorbing; no retry possible
   ```

Constraints:
- Exception MUST transition to FAILED_TERMINAL
- FAILED_TERMINAL is absorbing (no exit)
- Timer is NOT re-registered
- Tick loop MUST NOT re-evaluate this boundary

Done Criteria:
All exceptions during switch issuance result in FAILED_TERMINAL state; no retry cascade possible.

---

## Completion Status

| Field | Value |
|-------|-------|
| **Status** | COMPLETE |
| **Completed** | 2026-02-02 |
| **Implementation** | _on_switch_issue_deadline wraps issuance in try/except Exception; on exception or switch_to_live returning False → FAILED_TERMINAL and _pending_fatal; no re-arm. |
| **Tests** | Runtime tests (32 passed); duplicate issuance suppressed (P11F-004) visible in logs. |
