Task ID: P11F-002
Rule ID: INV-BOUNDARY-LIFECYCLE-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P11F-001

Instructions:
- Add BoundaryState enum with defined states
- Implement state transition enforcement
- Illegal transitions force FAILED_TERMINAL

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-BOUNDARY-LIFECYCLE-001):
Boundary state transitions MUST be unidirectional and follow the defined state machine. Illegal transitions force immediate transition to FAILED_TERMINAL.

Implementation:

1. Add BoundaryState enum:
   ```python
   from enum import Enum, auto

   class BoundaryState(Enum):
       NONE = auto()              # No boundary planned
       PLANNED = auto()           # Boundary computed, legacy preload RPC scheduled
       PRELOAD_ISSUED = auto()    # legacy preload RPC sent to AIR
       SWITCH_SCHEDULED = auto()  # Switch timer registered (one-shot)
       SWITCH_ISSUED = auto()     # legacy switch RPC sent to AIR
       LIVE = auto()              # AIR confirmed switch complete
       FAILED_TERMINAL = auto()   # Unrecoverable failure (absorbing)
   ```

2. Define allowed transitions:
   ```python
   _ALLOWED_TRANSITIONS: dict[BoundaryState, set[BoundaryState]] = {
       BoundaryState.NONE: {BoundaryState.PLANNED},
       BoundaryState.PLANNED: {BoundaryState.PRELOAD_ISSUED, BoundaryState.FAILED_TERMINAL},
       BoundaryState.PRELOAD_ISSUED: {BoundaryState.SWITCH_SCHEDULED, BoundaryState.FAILED_TERMINAL},
       BoundaryState.SWITCH_SCHEDULED: {BoundaryState.SWITCH_ISSUED, BoundaryState.FAILED_TERMINAL},
       BoundaryState.SWITCH_ISSUED: {BoundaryState.LIVE, BoundaryState.FAILED_TERMINAL},
       BoundaryState.LIVE: {BoundaryState.NONE, BoundaryState.PLANNED},  # Next boundary
       BoundaryState.FAILED_TERMINAL: set(),  # Absorbing
   }
   ```

3. Add transition enforcement:
   ```python
   def _transition_boundary_state(self, new_state: BoundaryState) -> None:
       old_state = self._boundary_state
       allowed = _ALLOWED_TRANSITIONS.get(old_state, set())

       if new_state not in allowed:
           self._logger.error(
               "INV-BOUNDARY-LIFECYCLE-001 VIOLATION: Illegal transition %s -> %s",
               old_state.name, new_state.name
           )
           self._boundary_state = BoundaryState.FAILED_TERMINAL
           self._pending_fatal = SchedulingError(
               f"Illegal boundary state transition: {old_state.name} -> {new_state.name}"
           )
           return

       self._logger.info(
           "INV-BOUNDARY-LIFECYCLE-001: Boundary transition %s -> %s",
           old_state.name, new_state.name
       )
       self._boundary_state = new_state
   ```

4. Initialize state in __init__:
   ```python
   self._boundary_state = BoundaryState.NONE
   ```

Constraints:
- LIVE is NOT absorbing (allows next boundary)
- FAILED_TERMINAL is absorbing (no exit)
- Illegal transitions force FAILED_TERMINAL, not exception

Done Criteria:
BoundaryState enum defined; all state transitions use _transition_boundary_state(); illegal transitions logged and forced to FAILED_TERMINAL.

---

## Completion Status

| Field | Value |
|-------|-------|
| **Status** | COMPLETE |
| **Completed** | 2026-02-02 |
| **Implementation** | BoundaryState enum and _ALLOWED_BOUNDARY_TRANSITIONS in channel_manager.py; _transition_boundary_state(); _boundary_state in __init__/stop_channel. All boundary transitions wired: start() → PLANNED; tick() after legacy preload RPC → PRELOAD_ISSUED then _schedule_switch_issuance then SWITCH_SCHEDULED; _on_switch_issue_deadline → SWITCH_ISSUED (or FAILED_TERMINAL on fatal); _handle_switch_complete → LIVE then PLANNED or NONE. Switch timer moved to after legacy preload RPC (P11D-011 preserved). |
| **Tests** | test_clock_driven_switch (incl. test_illegal_boundary_transition_forces_failed_terminal); test_prefeed_timing; 31 runtime tests passed. |
| **Unblocks** | P11F-003, P11F-004, P11F-005, P11F-006 |
