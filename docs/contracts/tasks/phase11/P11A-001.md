Task ID: P11A-001
Rule ID: INV-AUDIO-SAMPLE-CONTINUITY-001
Subsystem: FileProducer, FrameRingBuffer
Task Type: AUDIT
File(s) to Modify: (none - audit only)
Owner: AIR

Instructions:
- Audit current audio queue behavior under backpressure conditions
- Document findings in this file's "Findings" section below
- Do not modify code in this task
- Identify specific code paths where audio samples may be dropped

---

Rule Definition:
Audio sample continuity MUST be preserved during normal operation. Audio samples MUST NOT be dropped due to queue backpressure. Queue overflow MUST trigger producer throttling, not sample loss.

Audit Scope:
1. FileProducer audio decode path
2. FrameRingBuffer audio queue behavior when full
3. Any TryPush vs Push semantics for audio
4. Backpressure signaling between audio and video paths

Questions to Answer:
1. What happens when the audio queue is full and a new audio frame arrives?
2. Is there any code path that discards audio samples?
3. Are audio and video backpressure handled symmetrically?
4. What logging exists for audio queue overflow conditions?

Files to Examine:
- pkg/air/src/producers/file/FileProducer.cpp (audio decode loop)
- pkg/air/src/buffers/FrameRingBuffer.cpp (queue behavior)
- pkg/air/src/buffers/FrameRingBuffer.h (API contract)

Findings:

1. **FrameRingBuffer (PushAudioFrame):** When the audio queue is full, `PushAudioFrame()` returns `false` and does NOT drop the frame. The buffer never discards; the caller is responsible for handling the failure.

2. **FileProducer (ReceiveAudioFrames):** When `PushAudioFrame()` fails (queue full), the producer enters a **while (!output_buffer_.PushAudioFrame(output_audio_frame))** loop (line ~2373) and blocks: it yields or sleeps (`kProducerBackoffUs`) until space is available, then retries. The frame is never dropped due to queue backpressure.

3. **Video path symmetry:** Video uses the same pattern: `while (!output_buffer_.Push(output_frame))` (line ~1553) with backpressure retry. Audio and video are already throttled symmetrically at capacity (INV-P10-BACKPRESSURE-SYMMETRIC).

4. **Intentional audio discard paths (not backpressure):** Audio frames are discarded only in these cases: (a) writes_disabled_ (write barrier), (b) PTS before effective_seek_target_us_ (seek alignment), (c) AdmitFrame rejected (timeline/mapping), (d) video epoch not yet set (phase 6 gating), (e) shadow mode (INV-P8-AUDIO-GATE). None of these are queue overflow.

5. **Conclusion:** No code path drops audio samples due to queue backpressure. Queue overflow triggers producer throttling (block/wait), not sample loss. INV-AUDIO-SAMPLE-CONTINUITY-001 is already satisfied by current behavior; P11A-002/P11A-003 add observability and explicit throttle logging.

Done Criteria:
Document identifies all code paths where audio samples could be dropped under backpressure, or confirms none exist.

---

Completion (2026-02-01): Findings documented above. No drops under backpressure; producer blocks at capacity.

---

Completion (2026-02-01): Findings documented in this file. No drops under backpressure; producer blocks at capacity.
