Task ID: P11D-005
Rule ID: INV-CONTROL-NO-POLL-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: FIX
File(s) to Modify: pkg/core/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P11D-004

Instructions:
- Remove SwitchToLive retry loop
- Treat NOT_READY as fatal error (should never occur in deadline-authoritative mode)
- Treat PROTOCOL_VIOLATION as scheduling error requiring investigation

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Poll/retry loops exist because old code assumed "readiness gates switch execution." Under LAW-AUTHORITY-HIERARCHY, clock is authority — Core declares WHEN, AIR executes at that time. If Core declares a time it can't meet, that's a Core bug, not a "retry until ready" situation.

Rule Definition (INV-CONTROL-NO-POLL-001):
Core MUST NOT poll/retry SwitchToLive based on readiness. If AIR returns NOT_READY or PROTOCOL_VIOLATION, it represents a Core timing bug.

Implementation:

1. Remove retry loop from switch_to_live:
   ```python
   # OLD (polling pattern):
   async def switch_to_live(self, channel_id: int, plan_handle: str) -> bool:
       for attempt in range(MAX_SWITCH_ATTEMPTS):
           response = await self.air_client.switch_to_live(request)
           if response.status == SwitchStatus.OK:
               return True
           elif response.status == SwitchStatus.NOT_READY:
               logger.info(f"Switch not ready, retrying in {RETRY_DELAY_MS}ms...")
               await asyncio.sleep(RETRY_DELAY_MS / 1000)
       return False

   # NEW (declarative pattern):
   async def switch_to_live(self, channel_id: int, plan_handle: str) -> bool:
       request = self._build_switch_request(channel_id, plan_handle)
       response = await self.air_client.switch_to_live(request)

       if response.status == SwitchStatus.OK:
           logger.info(f"INV-CONTROL-NO-POLL-001: Switch scheduled for {request.target_boundary_time_ms}")
           return True

       elif response.status == SwitchStatus.PROTOCOL_VIOLATION:
           # This is a Core timing bug — we issued SwitchToLive too late
           logger.error(f"INV-CONTROL-NO-POLL-001 VIOLATION: {response.violation_reason}")
           raise SwitchTimingError(f"Protocol violation: {response.violation_reason}")

       elif response.status == SwitchStatus.NOT_READY:
           # Should never happen in deadline-authoritative mode
           logger.error("INV-CONTROL-NO-POLL-001 VIOLATION: Received deprecated NOT_READY response")
           raise SwitchProtocolError("Unexpected NOT_READY in deadline-authoritative mode")

       else:
           raise SwitchError(f"Switch failed: {response.status}")
   ```

2. Add timing assertion before issuing switch:
   ```python
   def _build_switch_request(self, channel_id: int, plan_handle: str) -> SwitchToLiveRequest:
       boundary_time = self._get_current_grid_boundary_time()
       now = datetime.now(timezone.utc)
       lead_time = boundary_time - now

       if lead_time < MIN_PREFEED_LEAD_TIME:
           logger.error(f"INV-CONTROL-NO-POLL-001 VIOLATION: Issuing switch with insufficient lead time "
                        f"({lead_time.total_seconds():.1f}s < {MIN_PREFEED_LEAD_TIME.total_seconds():.1f}s)")

       return SwitchToLiveRequest(
           channel_id=channel_id,
           plan_handle=plan_handle,
           target_boundary_time_ms=int(boundary_time.timestamp() * 1000)
       )
   ```

3. Define new exception types:
   ```python
   class SwitchTimingError(Exception):
       """Raised when switch issued with insufficient lead time."""
       pass

   class SwitchProtocolError(Exception):
       """Raised when AIR protocol contract violated."""
       pass
   ```

Log Specification:

Successful switch:
```
INV-CONTROL-NO-POLL-001: Switch scheduled for 1738340400000
```

Protocol violation:
```
INV-CONTROL-NO-POLL-001 VIOLATION: Insufficient prefeed lead time
```

Unexpected NOT_READY:
```
INV-CONTROL-NO-POLL-001 VIOLATION: Received deprecated NOT_READY response
```

Constraints:
- NO retry loops for SwitchToLive
- NOT_READY and PROTOCOL_VIOLATION are both treated as fatal
- Exception raised to propagate to operator alerting
- Violation logs MUST include enough context for debugging

Done Criteria:
Core never retries SwitchToLive; unexpected responses raise exceptions with violation logs.
