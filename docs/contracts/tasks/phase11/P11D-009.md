Task ID: P11D-009
Rule ID: INV-SCHED-PLAN-BEFORE-EXEC-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager/Scheduler
Task Type: FIX
File(s) to Modify: pkg/core/src/retrovue/runtime/channel_manager.py
Owner: Core
Blocked By: P11D-005
Blocks: P11D-006

Instructions:
- Scheduling feasibility MUST be determined at planning time
- Boundaries that cannot satisfy MIN_PREFEED_LEAD_TIME MUST be rejected during planning
- Runtime tick() MUST NOT evaluate, discover, compensate for, or branch on boundary feasibility

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Since clock doesn't wait, and since runtime cannot delay or retry, any boundary that cannot be honored MUST be rejected at planning time. The tick() loop assumes scheduling validity and MUST NOT attempt to repair infeasible boundaries.

Rule Definition (INV-SCHED-PLAN-BEFORE-EXEC-001):

Scheduling feasibility MUST be determined exactly once, during planning, before any execution-time control commands (including LoadPreview or SwitchToLive) are issued.

A boundary is eligible for execution only if, at the moment of planning, its scheduled time is greater than or equal to (planning_time + required_lead_time) for all applicable lead-time constraints (including MIN_PREFEED_LEAD_TIME).

Boundaries that do not meet this criterion are ineligible and MUST be discarded, not delayed, padded, retried, or otherwise adjusted. An ineligible boundary MUST NOT enter the runtime execution loop.

Planning is a one-shot, event-driven selection step, not a cadence-driven or time-polled process. Re-planning is permitted only when scheduling inputs change (e.g. channel start, segment commit, schedule mutation, or mode change). The passage of time alone MUST NOT trigger re-evaluation.

Runtime execution code MUST assume that all scheduled boundaries are feasible by construction and MUST NOT evaluate, discover, compensate for, or branch on boundary feasibility.

Scheduling errors are planning errors, not runtime errors. Runtime detection of infeasibility constitutes a violation of this invariant.

Root Cause Being Addressed:
The current mock schedule generator creates boundaries starting from "now". If the first boundary is only 2 seconds away, the tick() loop discovers this is infeasible and skips it. This inverts the correct model: scheduling created an infeasible plan, and runtime is compensating. Instead, scheduling should never create infeasible boundaries.

Implementation:

1. When generating schedule (mock or real), compute first feasible boundary using only MIN_PREFEED_LEAD_TIME (no extra margin). Discard any boundary whose time is earlier than (planning_time + MIN_PREFEED_LEAD_TIME); the first planned boundary is then feasible by construction. Example (see _first_feasible_boundary in channel_manager.py):
   ```python
   def _first_feasible_boundary(
       self, planning_time: datetime, segment_seconds: float, epoch_utc: datetime
   ) -> datetime:
       """First boundary >= planning_time + MIN_PREFEED_LEAD_TIME, aligned to grid. No margin."""
       min_lead_seconds = MIN_PREFEED_LEAD_TIME.total_seconds()
       earliest_feasible = planning_time + timedelta(seconds=min_lead_seconds)
       # Align to next segment boundary (epoch_utc + n * segment_seconds)
       # ...alignment logic...
       return aligned_boundary
   ```

2. Mock schedule generator MUST use first feasible boundary:
   ```python
   # When creating mock A/B schedule (or setting initial segment end at channel launch):
   first_boundary = self._first_feasible_boundary(planning_time, segment_seconds, epoch_utc)
   # Schedule starts at first_boundary, not at now
   ```

3. Remove runtime feasibility evaluation from tick():
   - tick() MUST NOT evaluate "is this boundary feasible?" (no check, no branch)
   - tick() MUST assume all boundaries in the schedule are feasible
   - If a boundary is encountered at runtime that cannot be honored, this constitutes proof that planning violated INV-SCHED-PLAN-BEFORE-EXEC-001 and MUST raise a FATAL error immediately.
   - Log: `INV-SCHED-PLAN-BEFORE-EXEC-001 FATAL: Infeasible boundary reached runtime`

4. Channel launch MUST use planning_time = station_utc (actual current station time). No artificial offset or margin. Select the first segment boundary whose boundary_time >= station_utc + MIN_PREFEED_LEAD_TIME. If no such boundary exists (e.g. no grid to select from, or plan yields only infeasible boundaries), planning MUST fail immediately (FATAL).
   ```python
   # At channel launch: planning_time = station_utc (no offset).
   # First boundary = _first_feasible_boundary(planning_time, segment_seconds, epoch_utc)
   # If plan has end_time_utc < planning_time + MIN_PREFEED_LEAD_TIME and no segment_seconds, raise SchedulingError (FATAL).
   # If final _segment_end_time_utc < planning_time + MIN_PREFEED_LEAD_TIME, raise SchedulingError (FATAL).
   ```

Constraints:
- Only boundaries feasible by construction may enter execution
- Ineligible boundaries MUST be discarded at planning time, not delayed, padded, or retried
- Planning is one-shot and event-driven; passage of time alone MUST NOT trigger re-evaluation
- Re-planning permitted only on input change (channel start, segment commit, schedule mutation, mode change)
- Runtime MUST assume all scheduled boundaries are feasible
- Runtime detection of infeasibility is a violation of this invariant
- Mock schedule generator MUST respect the same constraints as real schedule generation

Anti-Patterns (FORBIDDEN):
```python
# WRONG: Cadence-based feasibility check in tick loop
async def tick(self):
    for boundary in self.upcoming_boundaries:
        if not self._is_feasible(boundary):  # VIOLATION: runtime discovery
            self._skip_boundary(boundary)    # VIOLATION: runtime compensation
```

```python
# WRONG: Time-polled re-evaluation (passage of time triggering re-evaluation)
while True:
    await asyncio.sleep(1)
    if time_until_boundary < MIN_LEAD_TIME:  # VIOLATION: time-triggered re-evaluation
        logger.warning("skipping boundary")   # VIOLATION: runtime adjustment
```

```python
# WRONG: Delaying or padding ineligible boundary instead of discarding
if not feasible:
    boundary.time += padding  # VIOLATION: must discard, not adjust
```

```python
# WRONG: Advancing planning_time to "wait into" feasibility (INV-SCHED-PLAN-BEFORE-EXEC-001)
planning_time = station_utc + timedelta(seconds=LAUNCH_DELAY)  # VIOLATION: planning_time must be actual station time
```

```python
# WRONG: Tick-jitter padding to make feasibility depend on tick timing
switch_at = segment_end - (MIN_PREFEED_LEAD_TIME + tick_buffer)  # VIOLATION: feasibility by boundary selection only
```

Correct Pattern:
```python
# RIGHT: One-shot feasibility at planning time; planning_time = station_utc (actual current time)
def plan_boundaries(self, planning_time: datetime) -> list[Boundary]:
    assert planning_time == station_utc  # No offset or margin
    eligible = []
    for boundary in candidates:
        if boundary.time >= planning_time + MIN_PREFEED_LEAD_TIME:
            eligible.append(boundary)  # Feasible by construction
        # Ineligible boundaries discarded; if no eligible boundary, planning fails (FATAL)
    if not eligible:
        raise SchedulingError("INV-SCHED-PLAN-BEFORE-EXEC-001: No feasible boundary. Planning must fail.")
    return eligible
```

Done Criteria:
- planning_time = station_utc (actual current station time); no artificial offset or margin
- All boundaries entering execution are feasible by construction (boundary_time â‰¥ planning_time + MIN_PREFEED_LEAD_TIME)
- Ineligible boundaries discarded at planning time; if no feasible boundary exists, planning fails immediately (FATAL)
- No tick-jitter padding; tick() does not influence feasibility
- Runtime tick() contains no feasibility checks or skip logic
- Happy path test (P11D-006) passes: boundaries execute as scheduled, none skipped

---
**Done:** _first_feasible_boundary(planning_time, segment_seconds, epoch_utc); planning_time = station_utc at launch (no INITIAL_PLANNING_LEAD_SECONDS or offset). Planning discards boundaries < planning_time + MIN_PREFEED_LEAD_TIME; if no feasible boundary can be selected (e.g. end_time_utc infeasible and no grid, or duration fallback < MIN_PREFEED_LEAD_TIME), raise SchedulingError (FATAL). tick() has no feasibility checks; infeasible boundary at runtime raises SchedulingError (FATAL). No tick-jitter padding.

**Validation:** `./scripts/core/run_p11d006_real_assets.sh` passes; boundaries execute as scheduled; stream delivers bytes and TS sync.
