Task ID: P11F-008
Rule ID: INV-SWITCH-ISSUANCE-ONESHOT-001
Governing Law: LAW-AUTHORITY-HIERARCHY
Subsystem: ChannelManager
Task Type: TEST
File(s) to Modify: pkg/core/tests/test_channel_manager_oneshot.py
Owner: Core
Blocked By: P11F-004

Instructions:
- Add contract tests for one-shot issuance guard
- Verify duplicate into SWITCH_ISSUED/LIVE is suppressed
- Verify duplicate into FAILED_TERMINAL is FATAL
- Verify tick cannot re-trigger issuance

---

Governing Principle (LAW-AUTHORITY-HIERARCHY):
> Clock authority supersedes frame completion for switch execution.

Rule Definition (INV-SWITCH-ISSUANCE-ONESHOT-001):
SwitchToLive MUST be issued exactly once per boundary. Duplicate issuance attempts are suppressed. Duplicate into FAILED_TERMINAL is treated as a control-flow bug (FATAL).

Test Cases:

1. Test duplicate into SWITCH_ISSUED is suppressed:
   ```python
   async def test_duplicate_into_switch_issued_suppressed(self):
       """INV-SWITCH-ISSUANCE-ONESHOT-001: Duplicate into SWITCH_ISSUED is benign."""
       manager = self._create_manager()
       boundary_time = datetime.now(timezone.utc) + timedelta(seconds=10)

       # First issuance succeeds
       manager._boundary_state = BoundaryState.SWITCH_SCHEDULED
       result = manager._guard_switch_issuance(boundary_time)
       assert result is True

       # Simulate state transition
       manager._boundary_state = BoundaryState.SWITCH_ISSUED

       # Second issuance is suppressed
       result = manager._guard_switch_issuance(boundary_time)
       assert result is False
       # No fatal error set
       assert manager._pending_fatal is None
   ```

2. Test duplicate into LIVE is suppressed:
   ```python
   async def test_duplicate_into_live_suppressed(self):
       """INV-SWITCH-ISSUANCE-ONESHOT-001: Duplicate into LIVE is benign."""
       manager = self._create_manager()
       boundary_time = datetime.now(timezone.utc) + timedelta(seconds=10)

       manager._boundary_state = BoundaryState.LIVE
       result = manager._guard_switch_issuance(boundary_time)

       assert result is False
       assert manager._pending_fatal is None
   ```

3. Test duplicate into FAILED_TERMINAL is FATAL:
   ```python
   async def test_duplicate_into_terminal_is_fatal(self):
       """INV-SWITCH-ISSUANCE-ONESHOT-001: Duplicate into FAILED_TERMINAL is control-flow bug."""
       manager = self._create_manager()
       boundary_time = datetime.now(timezone.utc) + timedelta(seconds=10)

       manager._boundary_state = BoundaryState.FAILED_TERMINAL
       result = manager._guard_switch_issuance(boundary_time)

       assert result is False
       # FATAL error is set
       assert manager._pending_fatal is not None
       assert "FAILED_TERMINAL" in str(manager._pending_fatal)
   ```

4. Test tick does not re-evaluate processed boundary:
   ```python
   @pytest.mark.parametrize("terminal_state", [
       BoundaryState.SWITCH_ISSUED,
       BoundaryState.LIVE,
       BoundaryState.FAILED_TERMINAL,
   ])
   async def test_tick_skips_processed_boundary(self, terminal_state):
       """INV-SWITCH-ISSUANCE-ONESHOT-001: tick() does not re-trigger issuance."""
       manager = self._create_manager()
       manager._boundary_state = terminal_state

       # Mock the issuance method to detect if called
       issuance_called = False
       original = manager._on_switch_issue_deadline
       async def mock_issuance(*args):
           nonlocal issuance_called
           issuance_called = True
           return await original(*args)
       manager._on_switch_issue_deadline = mock_issuance

       # Run tick
       await manager.tick()

       # Issuance should NOT have been triggered
       assert issuance_called is False
   ```

5. Test full callback invoked only once:
   ```python
   async def test_callback_invokes_once(self):
       """INV-SWITCH-ISSUANCE-ONESHOT-001: Full flow issues exactly once."""
       manager = self._create_manager()
       boundary_time = datetime.now(timezone.utc) + timedelta(seconds=10)

       rpc_call_count = 0
       async def mock_rpc(*args):
           nonlocal rpc_call_count
           rpc_call_count += 1
       manager._issue_switch_to_live_impl = mock_rpc

       # First call succeeds
       manager._boundary_state = BoundaryState.SWITCH_SCHEDULED
       await manager._on_switch_issue_deadline(boundary_time)
       assert rpc_call_count == 1

       # Second call is guarded
       await manager._on_switch_issue_deadline(boundary_time)
       assert rpc_call_count == 1  # Still 1, not 2
   ```

Done Criteria:
Duplicate suppression tested for SWITCH_ISSUED and LIVE; FATAL behavior tested for FAILED_TERMINAL; tick guard tested; exactly-once semantics verified end-to-end.

---

## Completion Status

| Field | Value |
|-------|-------|
| **Status** | COMPLETE |
| **Completed** | 2026-02-02 |
| **Implementation** | pkg/core/tests/runtime/test_channel_manager_oneshot.py: test_duplicate_into_switch_issued_suppressed, test_duplicate_into_live_suppressed, test_duplicate_into_terminal_is_fatal, test_tick_skips_processed_boundary (parametrized), test_callback_invokes_once (full flow with CountingProducer). |
| **Tests** | 7 tests in test_channel_manager_oneshot.py; 71 runtime tests pass. |
