Task ID: P11E-004
Rule ID: INV-CONTROL-NO-POLL-001
Subsystem: ChannelManager
Task Type: METRICS
File(s) to Modify: pkg/core/retrovue/runtime/channel_manager.py, pkg/core/retrovue/metrics/metrics.py
Owner: Core
Blocked By: P11E-002

Instructions:
- Add metric: prefeed_lead_time_ms histogram
- Track actual lead time for all LoadPreview calls

---

Rule Definition:
Core MUST track prefeed lead time to ensure compliance with MIN_PREFEED_LEAD_TIME and enable operational visibility.

Implementation:

1. Define histogram metric:
   ```python
   # pkg/core/retrovue/metrics/metrics.py

   from prometheus_client import Histogram, Counter

   # Histogram for prefeed lead time
   # Buckets chosen to highlight violations (< 5000ms) and healthy ranges
   PREFEED_LEAD_TIME_BUCKETS = [
       500, 1000, 2000, 3000, 4000, 5000,  # Below MIN_PREFEED_LEAD_TIME
       6000, 7000, 8000, 10000, 15000, 30000  # Healthy range
   ]

   prefeed_lead_time_ms = Histogram(
       'retrovue_prefeed_lead_time_ms',
       'Lead time in milliseconds between LoadPreview and target boundary',
       ['channel_id'],
       buckets=PREFEED_LEAD_TIME_BUCKETS
   )

   prefeed_lead_time_violations_total = Counter(
       'retrovue_prefeed_lead_time_violations_total',
       'Count of LoadPreview calls with insufficient lead time',
       ['channel_id']
   )

   switch_lead_time_ms = Histogram(
       'retrovue_switch_lead_time_ms',
       'Lead time in milliseconds between SwitchToLive and target boundary',
       ['channel_id'],
       buckets=PREFEED_LEAD_TIME_BUCKETS
   )
   ```

2. Record metric in _issue_load_preview:
   ```python
   async def _issue_load_preview(self, channel_id: int, boundary: GridBoundary):
       now = datetime.now(timezone.utc)
       lead_time = boundary.time - now
       lead_time_ms = int(lead_time.total_seconds() * 1000)

       # Record lead time metric
       metrics.prefeed_lead_time_ms.labels(
           channel_id=str(channel_id)
       ).observe(lead_time_ms)

       # Check for violation
       if lead_time_ms < MIN_PREFEED_LEAD_TIME_MS:
           metrics.prefeed_lead_time_violations_total.labels(
               channel_id=str(channel_id)
           ).inc()
           # ... violation logging from P11E-003 ...

       # ... rest of implementation ...
   ```

3. Record metric in _issue_switch_to_live:
   ```python
   async def _issue_switch_to_live(self, channel_id: int, boundary: GridBoundary):
       now = datetime.now(timezone.utc)
       lead_time = boundary.time - now
       lead_time_ms = int(lead_time.total_seconds() * 1000)

       metrics.switch_lead_time_ms.labels(
           channel_id=str(channel_id)
       ).observe(lead_time_ms)

       # ... rest of implementation ...
   ```

4. Grafana dashboard queries:
   ```promql
   # Average prefeed lead time
   histogram_quantile(0.5, rate(retrovue_prefeed_lead_time_ms_bucket[5m]))

   # 95th percentile prefeed lead time
   histogram_quantile(0.95, rate(retrovue_prefeed_lead_time_ms_bucket[5m]))

   # Violation rate
   rate(retrovue_prefeed_lead_time_violations_total[5m])

   # % of prefeeds with < MIN_PREFEED_LEAD_TIME
   sum(rate(retrovue_prefeed_lead_time_ms_bucket{le="5000"}[5m]))
   /
   sum(rate(retrovue_prefeed_lead_time_ms_count[5m]))
   ```

5. Alert rule (example):
   ```yaml
   - alert: PrefeedLeadTimeViolation
     expr: rate(retrovue_prefeed_lead_time_violations_total[5m]) > 0
     for: 1m
     labels:
       severity: warning
     annotations:
       summary: "Prefeed timing violations detected"
       description: "Channel {{ $labels.channel_id }} has prefeed lead time violations"
   ```

Constraints:
- Metric MUST be recorded for every LoadPreview call
- Histogram buckets must allow visibility into violations
- Labels must include channel_id for per-channel analysis
- Consider adding success/failure label if needed

Done Criteria:
Histogram metric records prefeed lead time for all LoadPreview calls; visible in Prometheus/Grafana.
